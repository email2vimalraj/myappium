/*global describe:true, it:true, before:true, after:true */
"use strict";

var yiewd = require('../../lib/main.js')
  , Express = require('../server/express.js').Express
  , should = require('should')
  , baseUrl = 'http://127.0.0.1:8181/test/'
  , mo_Ocha = require("mo_ocha")
  , caps = { browserName: 'chrome' };

var origIt = GLOBAL.it;
mo_Ocha.rewrite();

describe('yiewd elements', function() {
  // handle running test server
  var server = new Express();
  var driver = null;
  before(wrapGenerator.mark(function callee$1$0() {
    return wrapGenerator(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
      case 0:
        server.start();
        driver = yiewd.remote();
        context$2$0.next = 4;
        return driver.init(caps);
      case 4:
      case "end":
        return context$2$0.stop();
      }
    }, callee$1$0, this);
  }));
  after(wrapGenerator.mark(function callee$1$1() {
    return wrapGenerator(function callee$1$1$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
      case 0:
        context$2$0.next = 2;
        return driver.quit();
      case 2:
      case "end":
        return context$2$0.stop();
      }
    }, callee$1$1, this);
  }));

  it('should click and get text', wrapGenerator.mark(function callee$1$2() {
    var anchor;

    return wrapGenerator(function callee$1$2$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
      case 0:
        context$2$0.next = 2;
        return driver.get(baseUrl + "guinea-pig.html");
      case 2:
        context$2$0.next = 4;
        return driver.elementByLinkText("i am a link");
      case 4:
        anchor = context$2$0.sent;
        context$2$0.next = 7;
        return anchor.text();
      case 7:
        context$2$0.sent.should.equal("i am a link");
        context$2$0.next = 10;
        return anchor.click();
      case 10:
        context$2$0.next = 12;
        return driver.title();
      case 12:
        context$2$0.sent.should.equal("I am another page title");
      case 13:
      case "end":
        return context$2$0.stop();
      }
    }, callee$1$2, this);
  }));

  it('should work getting els from els', wrapGenerator.mark(function callee$1$3() {
    var div, anchor, input, text;

    return wrapGenerator(function callee$1$3$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
      case 0:
        context$2$0.next = 2;
        return driver.back();
      case 2:
        context$2$0.next = 4;
        return driver.elementById('the_forms_id');
      case 4:
        div = context$2$0.sent;
        context$2$0.next = 7;
        return div.elementByTagName('p');
      case 7:
        anchor = context$2$0.sent;
        context$2$0.next = 10;
        return anchor.elementByTagName('input');
      case 10:
        input = context$2$0.sent;
        context$2$0.next = 13;
        return input.getAttribute('value');
      case 13:
        text = context$2$0.sent;
        text.should.equal("i has no focus");
      case 15:
      case "end":
        return context$2$0.stop();
      }
    }, callee$1$3, this);
  }));

  origIt('should fail when an element is not there', function(done) {
    driver.run(wrapGenerator.mark(function callee$2$0() {
      var e;

      return wrapGenerator(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
        case 0:
          context$3$0.prev = 0;
          context$3$0.next = 3;
          return driver.elementById('donotexistman');
        case 3:
          context$3$0.next = 8;
          break;
        case 5:
          context$3$0.prev = 5;
          context$3$0.t0 = context$3$0.catch(0);
          e = context$3$0.t0;
        case 8:
          e.message.should.include("7");
          context$3$0.next = 11;
          return driver.elementByTagName("nowaydude");
        case 11:
        case "end":
          return context$3$0.stop();
        }
      }, callee$2$0, this, [[0, 5]]);
    })).nodeify(function(err) {
      should.exist(err);
      err.message.should.include("NoSuchElement");
      done();
    });
  });

  it('should defer findElement if requested', wrapGenerator.mark(function callee$1$4() {
    var text;

    return wrapGenerator(function callee$1$4$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
      case 0:
        context$2$0.next = 2;
        return driver.get(baseUrl + "guinea-pig.html");
      case 2:
        context$2$0.next = 4;
        return driver.elementByLinkText("i am a link").click();
      case 4:
        context$2$0.next = 6;
        return driver.title();
      case 6:
        context$2$0.sent.should.equal("I am another page title");
        context$2$0.next = 9;
        return driver.back();
      case 9:
        context$2$0.next = 11;

        return driver.elementByTagName('body').elementById('the_forms_id')
          .elementByTagName('input').getValue();
      case 11:
        text = context$2$0.sent;
        text.should.equal("i has no focus");
      case 13:
      case "end":
        return context$2$0.stop();
      }
    }, callee$1$4, this);
  }));

});

