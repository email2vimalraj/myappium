require('source-map-support').install();

'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this = this;

var _ = require('../..');

var _2 = _interopRequireDefault(_);

var _libInstall = require('../lib/install');

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _q = require('q');

var _q2 = _interopRequireDefault(_q);

var _psNode = require('ps-node');

var _psNode2 = _interopRequireDefault(_psNode);

require('mochawait');

var should = _chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

function nextState(cd) {
  var d = _q2['default'].defer();
  cd.on(_2['default'].EVENT_CHANGED, function (msg) {
    d.resolve(msg.state);
  });
  return d.promise;
}

function nextError(cd) {
  var d = _q2['default'].defer();
  cd.on(_2['default'].EVENT_ERROR, function (err) {
    d.resolve(err);
  });
  return d.promise;
}

function assertNoRunningChromedrivers() {
  var res;
  return _regeneratorRuntime.async(function assertNoRunningChromedrivers$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_q2['default'].nfcall(_psNode2['default'].lookup, { command: /([^ ]*)chromedriver$/,
          psargs: 'aux' }));

      case 2:
        res = context$1$0.sent;

        res.should.have.length(0);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function buildReqRes(url, method, body) {
  var req = { originalUrl: url, method: method, body: body };
  var res = {};
  res.headers = {};
  res.set = function (k, v) {
    res[k] = v;
  };
  res.status = function (code) {
    res.sentCode = code;
    return {
      send: function send(body) {
        try {
          body = JSON.parse(body);
        } catch (e) {}
        res.sentBody = body;
      }
    };
  };
  return [req, res];
}

describe('chromedriver binary setup', function () {
  before(function callee$1$0() {
    var cd;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd = new _2['default']();
          context$2$0.prev = 1;
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(cd.initChromedriverPath());

        case 4:
          context$2$0.next = 11;
          break;

        case 6:
          context$2$0.prev = 6;
          context$2$0.t0 = context$2$0['catch'](1);

          if (!(context$2$0.t0.message.indexOf("Trying to use") !== -1)) {
            context$2$0.next = 11;
            break;
          }

          context$2$0.next = 11;
          return _regeneratorRuntime.awrap((0, _libInstall.install)());

        case 11:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this, [[1, 6]]);
  });

  it('should start with a binary that exists', function callee$1$0() {
    var cd;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd = new _2['default']();
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(cd.initChromedriverPath());

        case 3:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});

describe('chromedriver with EventEmitter', function () {
  var cd = null;
  var caps = { browserName: 'chrome' };
  before(function callee$1$0() {
    var opts;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          opts = {};

          cd = new _2['default'](opts);

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should start a session', function callee$1$0() {
    var nextStatePromise;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd.state.should.eql('stopped');
          nextStatePromise = nextState(cd);

          cd.start(caps);
          cd.capabilities.should.eql(caps);
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(nextStatePromise.should.become(_2['default'].STATE_STARTING));

        case 6:
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(nextState(cd).should.become(_2['default'].STATE_ONLINE));

        case 8:
          should.exist(cd.jwproxy.sessionId);
          should.exist(cd.sessionId());

        case 10:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should run some commands', function callee$1$0() {
    var res;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(cd.sendCommand('/url', 'POST', { url: 'http://google.com' }));

        case 2:
          res = context$2$0.sent;

          should.not.exist(res);
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(cd.sendCommand('/url', 'GET'));

        case 6:
          res = context$2$0.sent;

          res.should.contain('google');

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should proxy commands', function callee$1$0() {
    var initSessId, _buildReqRes, _buildReqRes2, req, res;

    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          initSessId = cd.sessionId();
          _buildReqRes = buildReqRes('/url', 'GET');
          _buildReqRes2 = _slicedToArray(_buildReqRes, 2);
          req = _buildReqRes2[0];
          res = _buildReqRes2[1];
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap(cd.proxyReq(req, res));

        case 7:
          res.headers['content-type'].should.contain('application/json');
          res.sentCode.should.equal(200);
          res.sentBody.status.should.equal(0);
          res.sentBody.value.should.contain('google');
          res.sentBody.sessionId.should.equal(initSessId);

        case 12:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should say whether there is a working webview', function callee$1$0() {
    var res;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(cd.hasWorkingWebview());

        case 2:
          res = context$2$0.sent;

          res.should.equal(true);

        case 4:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should restart a session', function callee$1$0() {
    var p1;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          p1 = nextState(cd);

          cd.restart();
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(p1.should.become(_2['default'].STATE_RESTARTING));

        case 4:
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(nextState(cd).should.become(_2['default'].STATE_ONLINE));

        case 6:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should stop a session', function callee$1$0() {
    var nextStatePromise;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          nextStatePromise = nextState(cd);

          cd.stop();
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(nextStatePromise.should.become(_2['default'].STATE_STOPPING));

        case 4:
          should.not.exist(cd.sessionId());
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap(nextState(cd).should.become(_2['default'].STATE_STOPPED));

        case 7:
          should.not.exist(cd.sessionId());
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap(assertNoRunningChromedrivers());

        case 10:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it.skip('should change state to stopped if chromedriver crashes', function callee$1$0() {
    var nextStatePromise;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          // test works but is skipped because it leaves a chrome window orphaned
          // and I can't figure out a way to safely kill only that one
          cd.state.should.eql(_2['default'].STATE_STOPPED);
          nextStatePromise = nextState(cd);

          cd.start(caps);
          cd.capabilities.should.eql(caps);
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(nextStatePromise.should.become(_2['default'].STATE_STARTING));

        case 6:
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(nextState(cd).should.become(_2['default'].STATE_ONLINE));

        case 8:
          should.exist(cd.jwproxy.sessionId);
          should.exist(cd.sessionId());
          nextStatePromise = nextState(cd);
          context$2$0.next = 13;
          return _regeneratorRuntime.awrap(cd.killAll());

        case 13:
          context$2$0.next = 15;
          return _regeneratorRuntime.awrap(nextStatePromise.should.become(_2['default'].STATE_STOPPED));

        case 15:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should throw an error when chromedriver doesnt exist', function callee$1$0() {
    var cd2, nextErrP, err;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd2 = new _2['default']({ executable: '/does/not/exist' });
          nextErrP = nextError(cd2);

          cd2.start({});
          context$2$0.next = 5;
          return _regeneratorRuntime.awrap(nextErrP);

        case 5:
          err = context$2$0.sent;

          err.message.should.contain('Trying to use');

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});

describe('chromedriver with asyncawait', function () {
  var cd = null;
  var caps = { browserName: 'chrome' };
  before(function callee$1$0() {
    var opts;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          opts = {};

          cd = new _2['default'](opts);

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should start a session', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd.state.should.eql('stopped');
          should.not.exist(cd.sessionId());
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(cd.start(caps));

        case 4:
          cd.capabilities.should.eql(caps);
          cd.state.should.eql(_2['default'].STATE_ONLINE);
          should.exist(cd.jwproxy.sessionId);
          should.exist(cd.sessionId());

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should restart a session', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd.state.should.eql(_2['default'].STATE_ONLINE);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(cd.restart());

        case 3:
          cd.state.should.eql(_2['default'].STATE_ONLINE);

        case 4:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should stop a session', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd.state.should.eql(_2['default'].STATE_ONLINE);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(cd.stop());

        case 3:
          cd.state.should.eql(_2['default'].STATE_STOPPED);
          should.not.exist(cd.sessionId());
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap(assertNoRunningChromedrivers());

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should throw an error during start if spawn doesnt work', function callee$1$0() {
    var badCd;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          badCd = new _2['default']({ port: 1 });
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(badCd.start(caps).should.eventually.be.rejectedWith('Could not proxy'));

        case 3:
          context$2$0.next = 5;
          return _regeneratorRuntime.awrap(assertNoRunningChromedrivers());

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should throw an error during start if session doesnt work', function callee$1$0() {
    var badCd;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          badCd = new _2['default']();
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(badCd.start({ chromeOptions: { badCap: 'foo' } }).should.eventually.be.rejectedWith('cannot parse capability'));

        case 3:
          context$2$0.next = 5;
          return _regeneratorRuntime.awrap(assertNoRunningChromedrivers());

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});

// we miss the opportunity to listen for the 'starting' state
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvY2hyb21lZHJpdmVyLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQkFFeUIsT0FBTzs7OzswQkFDUixnQkFBZ0I7O29CQUN2QixNQUFNOzs7OzhCQUNJLGtCQUFrQjs7OztpQkFDL0IsR0FBRzs7OztzQkFDRSxTQUFTOzs7O1FBQ3JCLFdBQVc7O0FBRWxCLElBQUksTUFBTSxHQUFHLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQzNCLGtCQUFLLEdBQUcsNkJBQWdCLENBQUM7O0FBRXpCLFNBQVMsU0FBUyxDQUFFLEVBQUUsRUFBRTtBQUN0QixNQUFJLENBQUMsR0FBRyxlQUFFLEtBQUssRUFBRSxDQUFDO0FBQ2xCLElBQUUsQ0FBQyxFQUFFLENBQUMsY0FBYSxhQUFhLEVBQUUsVUFBQSxHQUFHLEVBQUk7QUFDdkMsS0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7R0FDdEIsQ0FBQyxDQUFDO0FBQ0gsU0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDO0NBQ2xCOztBQUVELFNBQVMsU0FBUyxDQUFFLEVBQUUsRUFBRTtBQUN0QixNQUFJLENBQUMsR0FBRyxlQUFFLEtBQUssRUFBRSxDQUFDO0FBQ2xCLElBQUUsQ0FBQyxFQUFFLENBQUMsY0FBYSxXQUFXLEVBQUUsVUFBQSxHQUFHLEVBQUk7QUFDckMsS0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztHQUNoQixDQUFDLENBQUM7QUFDSCxTQUFPLENBQUMsQ0FBQyxPQUFPLENBQUM7Q0FDbEI7O0FBRUQsU0FBZSw0QkFBNEI7TUFDckMsR0FBRzs7Ozs7eUNBQVMsZUFBRSxNQUFNLENBQUMsb0JBQU8sTUFBTSxFQUFFLEVBQUMsT0FBTyxFQUFFLHNCQUFzQjtBQUMvQixnQkFBTSxFQUFFLEtBQUssRUFBQyxDQUFDOzs7QUFEcEQsV0FBRzs7QUFFUCxXQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FB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QUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGNBQWEsWUFBWSxDQUFDLENBQUM7OzJDQUN6QyxFQUFFLENBQUMsSUFBSSxFQUFFOzs7QUFDZixZQUFFLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsY0FBYSxhQUFhLENBQUMsQ0FBQztBQUNoRCxnQkFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7OzJDQUMzQiw0QkFBNEIsRUFBRTs7Ozs7OztHQUNyQyxDQUFDLENBQUM7QUFDSCxJQUFFLENBQUMseURBQXlELEVBQUU7UUFDeEQsS0FBSzs7OztBQUFMLGVBQUssR0FBRyxrQkFBaUIsRUFBQyxJQUFJLEVBQUUsQ0FBQyxFQUFDLENBQUM7OzJDQUNqQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQzs7OzsyQ0FDdEUsNEJBQTRCLEVBQUU7Ozs7Ozs7R0FDckMsQ0FBQyxDQUFDO0FBQ0gsSUFBRSxDQUFDLDJEQUEyRCxFQUFFO1FBQzFELEtBQUs7Ozs7QUFBTCxlQUFLLEdBQUcsbUJBQWtCOzsyQ0FDeEIsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFDLGFBQWEsRUFBRSxFQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUMsRUFBQyxDQUFDLENBQ3ZDLE1BQU0sQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyx5QkFBeUIsQ0FBQzs7OzsyQ0FDbEUsNEJBQTRCLEVBQUU7Ozs7Ozs7R0FDckMsQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwiZmlsZSI6InRlc3QvY2hyb21lZHJpdmVyLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHJhbnNwaWxlOm1vY2hhXG5cbmltcG9ydCBDaHJvbWVkcml2ZXIgZnJvbSAnLi4vLi4nO1xuaW1wb3J0IHsgaW5zdGFsbCB9IGZyb20gJy4uL2xpYi9pbnN0YWxsJztcbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IFEgZnJvbSAncSc7XG5pbXBvcnQgcHNOb2RlIGZyb20gJ3BzLW5vZGUnO1xuaW1wb3J0ICdtb2NoYXdhaXQnO1xuXG5sZXQgc2hvdWxkID0gY2hhaS5zaG91bGQoKTtcbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcblxuZnVuY3Rpb24gbmV4dFN0YXRlIChjZCkge1xuICBsZXQgZCA9IFEuZGVmZXIoKTtcbiAgY2Qub24oQ2hyb21lZHJpdmVyLkVWRU5UX0NIQU5HRUQsIG1zZyA9PiB7XG4gICAgZC5yZXNvbHZlKG1zZy5zdGF0ZSk7XG4gIH0pO1xuICByZXR1cm4gZC5wcm9taXNlO1xufVxuXG5mdW5jdGlvbiBuZXh0RXJyb3IgKGNkKSB7XG4gIGxldCBkID0gUS5kZWZlcigpO1xuICBjZC5vbihDaHJvbWVkcml2ZXIuRVZFTlRfRVJST1IsIGVyciA9PiB7XG4gICAgZC5yZXNvbHZlKGVycik7XG4gIH0pO1xuICByZXR1cm4gZC5wcm9taXNlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBhc3NlcnROb1J1bm5pbmdDaHJvbWVkcml2ZXJzICgpIHtcbiAgbGV0IHJlcyA9IGF3YWl0IFEubmZjYWxsKHBzTm9kZS5sb29rdXAsIHtjb21tYW5kOiAvKFteIF0qKWNocm9tZWRyaXZlciQvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBzYXJnczogJ2F1eCd9KTtcbiAgcmVzLnNob3VsZC5oYXZlLmxlbmd0aCgwKTtcbn1cblxuZnVuY3Rpb24gYnVpbGRSZXFSZXMgKHVybCwgbWV0aG9kLCBib2R5KSB7XG4gIGxldCByZXEgPSB7b3JpZ2luYWxVcmw6IHVybCwgbWV0aG9kLCBib2R5fTtcbiAgbGV0IHJlcyA9IHt9O1xuICByZXMuaGVhZGVycyA9IHt9O1xuICByZXMuc2V0ID0gKGssIHYpID0+IHsgcmVzW2tdID0gdjsgfTtcbiAgcmVzLnN0YXR1cyA9IChjb2RlKSA9PiB7XG4gICAgcmVzLnNlbnRDb2RlID0gY29kZTtcbiAgICByZXR1cm4ge1xuICAgICAgc2VuZDogKGJvZHkpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBib2R5ID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge31cbiAgICAgICAgcmVzLnNlbnRCb2R5ID0gYm9keTtcbiAgICAgIH1cbiAgICB9O1xuICB9O1xuICByZXR1cm4gW3JlcSwgcmVzXTtcbn1cblxuZGVzY3JpYmUoJ2Nocm9tZWRyaXZlciBiaW5hcnkgc2V0dXAnLCAoKSA9PiB7XG4gIGJlZm9yZShhc3luYyAoKSA9PiB7XG4gICAgbGV0IGNkID0gbmV3IENocm9tZWRyaXZlcigpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBjZC5pbml0Q2hyb21lZHJpdmVyUGF0aCgpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGVyci5tZXNzYWdlLmluZGV4T2YoXCJUcnlpbmcgdG8gdXNlXCIpICE9PSAtMSkge1xuICAgICAgICBhd2FpdCBpbnN0YWxsKCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICBpdCgnc2hvdWxkIHN0YXJ0IHdpdGggYSBiaW5hcnkgdGhhdCBleGlzdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGNkID0gbmV3IENocm9tZWRyaXZlcigpO1xuICAgIGF3YWl0IGNkLmluaXRDaHJvbWVkcml2ZXJQYXRoKCk7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKCdjaHJvbWVkcml2ZXIgd2l0aCBFdmVudEVtaXR0ZXInLCAoKSA9PiB7XG4gIGxldCBjZCA9IG51bGw7XG4gIGNvbnN0IGNhcHMgPSB7YnJvd3Nlck5hbWU6ICdjaHJvbWUnfTtcbiAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICBsZXQgb3B0cyA9IHt9O1xuICAgIGNkID0gbmV3IENocm9tZWRyaXZlcihvcHRzKTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgc3RhcnQgYSBzZXNzaW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIGNkLnN0YXRlLnNob3VsZC5lcWwoJ3N0b3BwZWQnKTtcbiAgICBsZXQgbmV4dFN0YXRlUHJvbWlzZSA9IG5leHRTdGF0ZShjZCk7XG4gICAgY2Quc3RhcnQoY2Fwcyk7XG4gICAgY2QuY2FwYWJpbGl0aWVzLnNob3VsZC5lcWwoY2Fwcyk7XG4gICAgYXdhaXQgbmV4dFN0YXRlUHJvbWlzZS5zaG91bGQuYmVjb21lKENocm9tZWRyaXZlci5TVEFURV9TVEFSVElORyk7XG4gICAgYXdhaXQgbmV4dFN0YXRlKGNkKS5zaG91bGQuYmVjb21lKENocm9tZWRyaXZlci5TVEFURV9PTkxJTkUpO1xuICAgIHNob3VsZC5leGlzdChjZC5qd3Byb3h5LnNlc3Npb25JZCk7XG4gICAgc2hvdWxkLmV4aXN0KGNkLnNlc3Npb25JZCgpKTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgcnVuIHNvbWUgY29tbWFuZHMnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IHJlcyA9IGF3YWl0IGNkLnNlbmRDb21tYW5kKCcvdXJsJywgJ1BPU1QnLCB7dXJsOiAnaHR0cDovL2dvb2dsZS5jb20nfSk7XG4gICAgc2hvdWxkLm5vdC5leGlzdChyZXMpO1xuICAgIHJlcyA9IGF3YWl0IGNkLnNlbmRDb21tYW5kKCcvdXJsJywgJ0dFVCcpO1xuICAgIHJlcy5zaG91bGQuY29udGFpbignZ29vZ2xlJyk7XG4gIH0pO1xuICBpdCgnc2hvdWxkIHByb3h5IGNvbW1hbmRzJywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCBpbml0U2Vzc0lkID0gY2Quc2Vzc2lvbklkKCk7XG4gICAgbGV0IFtyZXEsIHJlc10gPSBidWlsZFJlcVJlcygnL3VybCcsICdHRVQnKTtcbiAgICBhd2FpdCBjZC5wcm94eVJlcShyZXEsIHJlcyk7XG4gICAgcmVzLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddLnNob3VsZC5jb250YWluKCdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgcmVzLnNlbnRDb2RlLnNob3VsZC5lcXVhbCgyMDApO1xuICAgIHJlcy5zZW50Qm9keS5zdGF0dXMuc2hvdWxkLmVxdWFsKDApO1xuICAgIHJlcy5zZW50Qm9keS52YWx1ZS5zaG91bGQuY29udGFpbignZ29vZ2xlJyk7XG4gICAgcmVzLnNlbnRCb2R5LnNlc3Npb25JZC5zaG91bGQuZXF1YWwoaW5pdFNlc3NJZCk7XG4gIH0pO1xuICBpdCgnc2hvdWxkIHNheSB3aGV0aGVyIHRoZXJlIGlzIGEgd29ya2luZyB3ZWJ2aWV3JywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCByZXMgPSBhd2FpdCBjZC5oYXNXb3JraW5nV2VidmlldygpO1xuICAgIHJlcy5zaG91bGQuZXF1YWwodHJ1ZSk7XG4gIH0pO1xuICBpdCgnc2hvdWxkIHJlc3RhcnQgYSBzZXNzaW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCBwMSA9IG5leHRTdGF0ZShjZCk7XG4gICAgY2QucmVzdGFydCgpO1xuICAgIGF3YWl0IHAxLnNob3VsZC5iZWNvbWUoQ2hyb21lZHJpdmVyLlNUQVRFX1JFU1RBUlRJTkcpO1xuICAgIC8vIHdlIG1pc3MgdGhlIG9wcG9ydHVuaXR5IHRvIGxpc3RlbiBmb3IgdGhlICdzdGFydGluZycgc3RhdGVcbiAgICBhd2FpdCBuZXh0U3RhdGUoY2QpLnNob3VsZC5iZWNvbWUoQ2hyb21lZHJpdmVyLlNUQVRFX09OTElORSk7XG4gIH0pO1xuICBpdCgnc2hvdWxkIHN0b3AgYSBzZXNzaW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCBuZXh0U3RhdGVQcm9taXNlID0gbmV4dFN0YXRlKGNkKTtcbiAgICBjZC5zdG9wKCk7XG4gICAgYXdhaXQgbmV4dFN0YXRlUHJvbWlzZS5zaG91bGQuYmVjb21lKENocm9tZWRyaXZlci5TVEFURV9TVE9QUElORyk7XG4gICAgc2hvdWxkLm5vdC5leGlzdChjZC5zZXNzaW9uSWQoKSk7XG4gICAgYXdhaXQgbmV4dFN0YXRlKGNkKS5zaG91bGQuYmVjb21lKENocm9tZWRyaXZlci5TVEFURV9TVE9QUEVEKTtcbiAgICBzaG91bGQubm90LmV4aXN0KGNkLnNlc3Npb25JZCgpKTtcbiAgICBhd2FpdCBhc3NlcnROb1J1bm5pbmdDaHJvbWVkcml2ZXJzKCk7XG4gIH0pO1xuICBpdC5za2lwKCdzaG91bGQgY2hhbmdlIHN0YXRlIHRvIHN0b3BwZWQgaWYgY2hyb21lZHJpdmVyIGNyYXNoZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gdGVzdCB3b3JrcyBidXQgaXMgc2tpcHBlZCBiZWNhdXNlIGl0IGxlYXZlcyBhIGNocm9tZSB3aW5kb3cgb3JwaGFuZWRcbiAgICAvLyBhbmQgSSBjYW4ndCBmaWd1cmUgb3V0IGEgd2F5IHRvIHNhZmVseSBraWxsIG9ubHkgdGhhdCBvbmVcbiAgICBjZC5zdGF0ZS5zaG91bGQuZXFsKENocm9tZWRyaXZlci5TVEFURV9TVE9QUEVEKTtcbiAgICBsZXQgbmV4dFN0YXRlUHJvbWlzZSA9IG5leHRTdGF0ZShjZCk7XG4gICAgY2Quc3RhcnQoY2Fwcyk7XG4gICAgY2QuY2FwYWJpbGl0aWVzLnNob3VsZC5lcWwoY2Fwcyk7XG4gICAgYXdhaXQgbmV4dFN0YXRlUHJvbWlzZS5zaG91bGQuYmVjb21lKENocm9tZWRyaXZlci5TVEFURV9TVEFSVElORyk7XG4gICAgYXdhaXQgbmV4dFN0YXRlKGNkKS5zaG91bGQuYmVjb21lKENocm9tZWRyaXZlci5TVEFURV9PTkxJTkUpO1xuICAgIHNob3VsZC5leGlzdChjZC5qd3Byb3h5LnNlc3Npb25JZCk7XG4gICAgc2hvdWxkLmV4aXN0KGNkLnNlc3Npb25JZCgpKTtcbiAgICBuZXh0U3RhdGVQcm9taXNlID0gbmV4dFN0YXRlKGNkKTtcbiAgICBhd2FpdCBjZC5raWxsQWxsKCk7XG4gICAgYXdhaXQgbmV4dFN0YXRlUHJvbWlzZS5zaG91bGQuYmVjb21lKENocm9tZWRyaXZlci5TVEFURV9TVE9QUEVEKTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgdGhyb3cgYW4gZXJyb3Igd2hlbiBjaHJvbWVkcml2ZXIgZG9lc250IGV4aXN0JywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCBjZDIgPSBuZXcgQ2hyb21lZHJpdmVyKHtleGVjdXRhYmxlOiAnL2RvZXMvbm90L2V4aXN0J30pO1xuICAgIGxldCBuZXh0RXJyUCA9IG5leHRFcnJvcihjZDIpO1xuICAgIGNkMi5zdGFydCh7fSk7XG4gICAgbGV0IGVyciA9IGF3YWl0IG5leHRFcnJQO1xuICAgIGVyci5tZXNzYWdlLnNob3VsZC5jb250YWluKCdUcnlpbmcgdG8gdXNlJyk7XG4gIH0pO1xufSk7XG5cblxuZGVzY3JpYmUoJ2Nocm9tZWRyaXZlciB3aXRoIGFzeW5jYXdhaXQnLCAoKSA9PiB7XG4gIGxldCBjZCA9IG51bGw7XG4gIGNvbnN0IGNhcHMgPSB7YnJvd3Nlck5hbWU6ICdjaHJvbWUnfTtcbiAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICBsZXQgb3B0cyA9IHt9O1xuICAgIGNkID0gbmV3IENocm9tZWRyaXZlcihvcHRzKTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgc3RhcnQgYSBzZXNzaW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIGNkLnN0YXRlLnNob3VsZC5lcWwoJ3N0b3BwZWQnKTtcbiAgICBzaG91bGQubm90LmV4aXN0KGNkLnNlc3Npb25JZCgpKTtcbiAgICBhd2FpdCBjZC5zdGFydChjYXBzKTtcbiAgICBjZC5jYXBhYmlsaXRpZXMuc2hvdWxkLmVxbChjYXBzKTtcbiAgICBjZC5zdGF0ZS5zaG91bGQuZXFsKENocm9tZWRyaXZlci5TVEFURV9PTkxJTkUpO1xuICAgIHNob3VsZC5leGlzdChjZC5qd3Byb3h5LnNlc3Npb25JZCk7XG4gICAgc2hvdWxkLmV4aXN0KGNkLnNlc3Npb25JZCgpKTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgcmVzdGFydCBhIHNlc3Npb24nLCBhc3luYyAoKSA9PiB7XG4gICAgY2Quc3RhdGUuc2hvdWxkLmVxbChDaHJvbWVkcml2ZXIuU1RBVEVfT05MSU5FKTtcbiAgICBhd2FpdCBjZC5yZXN0YXJ0KCk7XG4gICAgY2Quc3RhdGUuc2hvdWxkLmVxbChDaHJvbWVkcml2ZXIuU1RBVEVfT05MSU5FKTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgc3RvcCBhIHNlc3Npb24nLCBhc3luYyAoKSA9PiB7XG4gICAgY2Quc3RhdGUuc2hvdWxkLmVxbChDaHJvbWVkcml2ZXIuU1RBVEVfT05MSU5FKTtcbiAgICBhd2FpdCBjZC5zdG9wKCk7XG4gICAgY2Quc3RhdGUuc2hvdWxkLmVxbChDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBFRCk7XG4gICAgc2hvdWxkLm5vdC5leGlzdChjZC5zZXNzaW9uSWQoKSk7XG4gICAgYXdhaXQgYXNzZXJ0Tm9SdW5uaW5nQ2hyb21lZHJpdmVycygpO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCB0aHJvdyBhbiBlcnJvciBkdXJpbmcgc3RhcnQgaWYgc3Bhd24gZG9lc250IHdvcmsnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGJhZENkID0gbmV3IENocm9tZWRyaXZlcih7cG9ydDogMX0pO1xuICAgIGF3YWl0IGJhZENkLnN0YXJ0KGNhcHMpLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgnQ291bGQgbm90IHByb3h5Jyk7XG4gICAgYXdhaXQgYXNzZXJ0Tm9SdW5uaW5nQ2hyb21lZHJpdmVycygpO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCB0aHJvdyBhbiBlcnJvciBkdXJpbmcgc3RhcnQgaWYgc2Vzc2lvbiBkb2VzbnQgd29yaycsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgYmFkQ2QgPSBuZXcgQ2hyb21lZHJpdmVyKCk7XG4gICAgYXdhaXQgYmFkQ2Quc3RhcnQoe2Nocm9tZU9wdGlvbnM6IHtiYWRDYXA6ICdmb28nfX0pXG4gICAgICAgICAgICAgICAuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKCdjYW5ub3QgcGFyc2UgY2FwYWJpbGl0eScpO1xuICAgIGF3YWl0IGFzc2VydE5vUnVubmluZ0Nocm9tZWRyaXZlcnMoKTtcbiAgfSk7XG59KTtcbiJdfQ==