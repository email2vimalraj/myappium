'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _appiumSupport = require('appium-support');

var _appiumSupport2 = _interopRequireDefault(_appiumSupport);

var _appiumLogger = require('appium-logger');

var _q = require('q');

var _q2 = _interopRequireDefault(_q);

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _admZip = require('adm-zip');

var _admZip2 = _interopRequireDefault(_admZip);

var _asyncbox = require('asyncbox');

var _utils = require('./utils');

var system = _appiumSupport2['default'].system;
var tempDir = _appiumSupport2['default'].tempDir;
var util = _appiumSupport2['default'].util;

var log = (0, _appiumLogger.getLogger)('Chromedriver Install');

var CD_VER = process.env.npm_config_chromedriver_version || "2.18";
var CD_CDN = process.env.npm_config_chromedriver_cdnurl || process.env.CHROMEDRIVER_CDNURL || "http://chromedriver.storage.googleapis.com";
var CD_BASE_DIR = _path2['default'].resolve(__dirname, "..", "..", "chromedriver");
var CD_PLATS = ["linux", "win", "mac"];
var CD_ARCHS = ["32", "64"];

var getCurArch = _q2['default'].denodeify(system.arch);
var writeFile = _q2['default'].denodeify(_fs2['default'].writeFile);
var readFile = _q2['default'].denodeify(_fs2['default'].readFile);
var mkdir = _q2['default'].denodeify(_fs2['default'].mkdir);
var chmod = _q2['default'].denodeify(_fs2['default'].chmod);
var mkdirp = util.mkdirp;

function getCurPlatform() {
  return system.isWindows() ? "win" : system.isMac() ? "mac" : "linux";
}

function getChromedriverDir() {
  var platform = arguments.length <= 0 || arguments[0] === undefined ? null : arguments[0];

  if (!platform) {
    platform = getCurPlatform();
  }
  return _path2['default'].resolve(CD_BASE_DIR, platform);
}

function getChromedriverBinaryPath() {
  var platform = arguments.length <= 0 || arguments[0] === undefined ? null : arguments[0];
  var arch = arguments.length <= 1 || arguments[1] === undefined ? null : arguments[1];
  var baseDir, ext;
  return _regeneratorRuntime.async(function getChromedriverBinaryPath$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!platform) {
          platform = getCurPlatform();
        }
        baseDir = getChromedriverDir(platform);
        ext = "";

        if (!(platform === "win")) {
          context$1$0.next = 7;
          break;
        }

        ext = ".exe";
        context$1$0.next = 13;
        break;

      case 7:
        if (!(platform === "linux")) {
          context$1$0.next = 13;
          break;
        }

        if (arch) {
          context$1$0.next = 12;
          break;
        }

        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(getCurArch());

      case 11:
        arch = context$1$0.sent;

      case 12:
        ext = "_" + arch;

      case 13:
        return context$1$0.abrupt('return', _path2['default'].resolve(baseDir, 'chromedriver' + ext));

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getDownloadUrl(version, platform, arch) {
  return CD_CDN + '/' + version + '/chromedriver_' + platform + arch + '.zip';
}

function validatePlatform(platform, arch) {
  if (!_lodash2['default'].contains(CD_PLATS, platform)) {
    throw new Error('Invalid platform: ' + platform);
  }
  if (!_lodash2['default'].contains(CD_ARCHS, arch)) {
    throw new Error('Invalid arch: ' + arch);
  }
  if (arch === "64" && platform !== "linux") {
    throw new Error("Only linux has a 64-bit version of Chromedriver");
  }
}

function installForPlatform(version, platform, arch) {
  var url, binarySpec, tempFile, body, tempUnzipped, zip, extractedBin, newBin, binContents;
  return _regeneratorRuntime.async(function installForPlatform$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        validatePlatform(platform, arch);
        url = getDownloadUrl(version, platform, arch);
        binarySpec = 'chromedriver_' + platform + arch;

        log.info('Opening temp file to write ' + binarySpec + ' to...');
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(tempDir.open({
          prefix: binarySpec,
          suffix: '.zip'
        }));

      case 6:
        tempFile = context$1$0.sent;

        // actually download the zipfile and write it with appropriate perms
        log.info('Downloading ' + url + '...');
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ url: url, encoding: 'binary' }));

      case 10:
        body = context$1$0.sent;

        log.info('Writing binary content to ' + tempFile.path + '...');
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(writeFile(tempFile.path, body, { encoding: 'binary' }));

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(chmod(tempFile.path, 420));

      case 16:
        tempUnzipped = _path2['default'].resolve(_path2['default'].dirname(tempFile.path), binarySpec);

        log.info('Extracting ' + tempFile.path + ' to ' + tempUnzipped);
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(mkdir(tempUnzipped));

      case 20:
        zip = new _admZip2['default'](tempFile.path);

        zip.extractAllTo(tempUnzipped, true);
        extractedBin = _path2['default'].resolve(tempUnzipped, "chromedriver");

        if (platform === "win") {
          extractedBin += ".exe";
        }

        // make build dirs that will hold the chromedriver binary
        log.info('Creating ' + _path2['default'].resolve(CD_BASE_DIR, platform) + '...');
        context$1$0.next = 27;
        return _regeneratorRuntime.awrap(mkdirp(CD_BASE_DIR));

      case 27:
        context$1$0.next = 29;
        return _regeneratorRuntime.awrap(mkdirp(_path2['default'].resolve(CD_BASE_DIR, platform)));

      case 29:
        context$1$0.next = 31;
        return _regeneratorRuntime.awrap(getChromedriverBinaryPath(platform, arch));

      case 31:
        newBin = context$1$0.sent;

        log.info('Copying unzipped binary, reading from ' + extractedBin + '...');
        context$1$0.next = 35;
        return _regeneratorRuntime.awrap(readFile(extractedBin, { encoding: 'binary' }));

      case 35:
        binContents = context$1$0.sent;

        log.info('Writing to ' + newBin + '...');
        context$1$0.next = 39;
        return _regeneratorRuntime.awrap(writeFile(newBin, binContents, { encoding: 'binary', mode: 493 }));

      case 39:
        log.info(newBin + ' successfully put in place');

      case 40:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function install() {
  var arch, platform;
  return _regeneratorRuntime.async(function install$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(getCurArch());

      case 2:
        arch = context$1$0.sent;
        platform = getCurPlatform();

        if (platform !== "linux" && arch === "64") {
          arch = "32";
        }
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(installForPlatform(CD_VER, platform, arch));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function conditionalInstall() {
  var arch, platform, binPath;
  return _regeneratorRuntime.async(function conditionalInstall$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(getCurArch());

      case 2:
        arch = context$1$0.sent;
        platform = getCurPlatform();

        if (platform !== "linux" && arch === "64") {
          arch = "32";
        }
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(getChromedriverBinaryPath(platform, arch));

      case 7:
        binPath = context$1$0.sent;
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap((0, _utils.exists)(binPath));

      case 10:
        if (context$1$0.sent) {
          context$1$0.next = 15;
          break;
        }

        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(installForPlatform(CD_VER, platform, arch));

      case 13:
        context$1$0.next = 16;
        break;

      case 15:
        log.info('No need to install chromedriver, ' + binPath + ' exists');

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function installAll() {
  var plats, downloads, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, platform, arch;

  return _regeneratorRuntime.async(function installAll$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        plats = [['linux', '32'], ['linux', '64'], ['win', '32'], ['mac', '32']];
        downloads = [];
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 5;

        for (_iterator = _getIterator(plats); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          _step$value = _slicedToArray(_step.value, 2);
          platform = _step$value[0];
          arch = _step$value[1];

          downloads.push(installForPlatform(CD_VER, platform, arch));
        }
        context$1$0.next = 13;
        break;

      case 9:
        context$1$0.prev = 9;
        context$1$0.t0 = context$1$0['catch'](5);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 13:
        context$1$0.prev = 13;
        context$1$0.prev = 14;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 16:
        context$1$0.prev = 16;

        if (!_didIteratorError) {
          context$1$0.next = 19;
          break;
        }

        throw _iteratorError;

      case 19:
        return context$1$0.finish(16);

      case 20:
        return context$1$0.finish(13);

      case 21:
        context$1$0.next = 23;
        return _regeneratorRuntime.awrap((0, _asyncbox.parallel)(downloads));

      case 23:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[5, 9, 13, 21], [14,, 16, 20]]);
}

function doInstall() {
  return _regeneratorRuntime.async(function doInstall$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!_lodash2['default'].contains(process.argv, '--all')) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(installAll());

      case 3:
        context$1$0.next = 12;
        break;

      case 5:
        if (!_lodash2['default'].contains(process.argv, '--conditional')) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(conditionalInstall());

      case 8:
        context$1$0.next = 12;
        break;

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(install());

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.getChromedriverBinaryPath = getChromedriverBinaryPath;
exports.install = install;
exports.installAll = installAll;
exports.CD_BASE_DIR = CD_BASE_DIR;
exports.getCurPlatform = getCurPlatform;
exports.conditionalInstall = conditionalInstall;
exports.doInstall = doInstall;

// set up a temp file to download the chromedriver zipfile to

// extract downloaded zipfile to tempdir

// copy the extracted binary to the correct build dir
//# sourceMappingURL=data:application/json;base64,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RCxTQUFlLFVBQVU7TUFDakIsS0FBSyxFQU1QLFNBQVMsK0ZBQ0gsUUFBUSxFQUFFLElBQUk7Ozs7O0FBUGxCLGFBQUssR0FBRyxDQUNaLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUNmLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUNmLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUNiLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUNkO0FBQ0csaUJBQVMsR0FBRyxFQUFFOzs7Ozs7QUFDbEIsc0NBQTZCLEtBQUsscUdBQUU7O0FBQTFCLGtCQUFRO0FBQUUsY0FBSTs7QUFDdEIsbUJBQVMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1NBQzVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7eUNBQ0ssY0E1SUMsUUFBUSxFQTRJTixTQUFTLENBQUM7Ozs7Ozs7Q0FDcEI7O0FBRUQsU0FBZSxTQUFTOzs7O2FBQ2xCLG9CQUFFLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQzs7Ozs7O3lDQUM3QixVQUFVLEVBQUU7Ozs7Ozs7YUFDVCxvQkFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxlQUFlLENBQUM7Ozs7Ozt5Q0FDNUMsa0JBQWtCLEVBQUU7Ozs7Ozs7O3lDQUVwQixPQUFPLEVBQUU7Ozs7Ozs7Q0FFbEI7O1FBRVEseUJBQXlCLEdBQXpCLHlCQUF5QjtRQUFFLE9BQU8sR0FBUCxPQUFPO1FBQUUsVUFBVSxHQUFWLFVBQVU7UUFBRSxXQUFXLEdBQVgsV0FBVztRQUMzRCxjQUFjLEdBQWQsY0FBYztRQUFFLGtCQUFrQixHQUFsQixrQkFBa0I7UUFBRSxTQUFTLEdBQVQsU0FBUyIsImZpbGUiOiJsaWIvaW5zdGFsbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgc3VwcG9ydCBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBnZXRMb2dnZXIgfSBmcm9tICdhcHBpdW0tbG9nZ2VyJztcbmltcG9ydCBRIGZyb20gJ3EnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCBBZG1aaXAgZnJvbSAnYWRtLXppcCc7XG5pbXBvcnQgeyBwYXJhbGxlbCBhcyBsbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGV4aXN0cyB9IGZyb20gJy4vdXRpbHMnO1xuY29uc3QgeyBzeXN0ZW0sIHRlbXBEaXIsIHV0aWwgfSA9IHN1cHBvcnQ7XG5jb25zdCBsb2cgPSBnZXRMb2dnZXIoJ0Nocm9tZWRyaXZlciBJbnN0YWxsJyk7XG5cbmNvbnN0IENEX1ZFUiA9IHByb2Nlc3MuZW52Lm5wbV9jb25maWdfY2hyb21lZHJpdmVyX3ZlcnNpb24gfHwgXCIyLjE4XCI7XG5jb25zdCBDRF9DRE4gPSBwcm9jZXNzLmVudi5ucG1fY29uZmlnX2Nocm9tZWRyaXZlcl9jZG51cmwgfHxcbiAgICAgICAgICAgICAgIHByb2Nlc3MuZW52LkNIUk9NRURSSVZFUl9DRE5VUkwgfHxcbiAgICAgICAgICAgICAgIFwiaHR0cDovL2Nocm9tZWRyaXZlci5zdG9yYWdlLmdvb2dsZWFwaXMuY29tXCI7XG5jb25zdCBDRF9CQVNFX0RJUiA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIFwiLi5cIiwgXCIuLlwiLCBcImNocm9tZWRyaXZlclwiKTtcbmNvbnN0IENEX1BMQVRTID0gW1wibGludXhcIiwgXCJ3aW5cIiwgXCJtYWNcIl07XG5jb25zdCBDRF9BUkNIUyA9IFtcIjMyXCIsIFwiNjRcIl07XG5cbmNvbnN0IGdldEN1ckFyY2ggPSBRLmRlbm9kZWlmeShzeXN0ZW0uYXJjaCk7XG5jb25zdCB3cml0ZUZpbGUgPSBRLmRlbm9kZWlmeShmcy53cml0ZUZpbGUpO1xuY29uc3QgcmVhZEZpbGUgPSBRLmRlbm9kZWlmeShmcy5yZWFkRmlsZSk7XG5jb25zdCBta2RpciA9IFEuZGVub2RlaWZ5KGZzLm1rZGlyKTtcbmNvbnN0IGNobW9kID0gUS5kZW5vZGVpZnkoZnMuY2htb2QpO1xuY29uc3QgbWtkaXJwID0gdXRpbC5ta2RpcnA7XG5cbmZ1bmN0aW9uIGdldEN1clBsYXRmb3JtICgpIHtcbiAgcmV0dXJuIHN5c3RlbS5pc1dpbmRvd3MoKSA/IFwid2luXCIgOiAoc3lzdGVtLmlzTWFjKCkgPyBcIm1hY1wiIDogXCJsaW51eFwiKTtcbn1cblxuZnVuY3Rpb24gZ2V0Q2hyb21lZHJpdmVyRGlyIChwbGF0Zm9ybSA9IG51bGwpIHtcbiAgaWYgKCFwbGF0Zm9ybSkge1xuICAgIHBsYXRmb3JtID0gZ2V0Q3VyUGxhdGZvcm0oKTtcbiAgfVxuICByZXR1cm4gcGF0aC5yZXNvbHZlKENEX0JBU0VfRElSLCBwbGF0Zm9ybSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldENocm9tZWRyaXZlckJpbmFyeVBhdGggKHBsYXRmb3JtID0gbnVsbCwgYXJjaCA9IG51bGwpIHtcbiAgaWYgKCFwbGF0Zm9ybSkge1xuICAgIHBsYXRmb3JtID0gZ2V0Q3VyUGxhdGZvcm0oKTtcbiAgfVxuICBjb25zdCBiYXNlRGlyID0gZ2V0Q2hyb21lZHJpdmVyRGlyKHBsYXRmb3JtKTtcbiAgbGV0IGV4dCA9IFwiXCI7XG4gIGlmIChwbGF0Zm9ybSA9PT0gXCJ3aW5cIikge1xuICAgIGV4dCA9IFwiLmV4ZVwiO1xuICB9IGVsc2UgaWYgKHBsYXRmb3JtID09PSBcImxpbnV4XCIpIHtcbiAgICBpZiAoIWFyY2gpIHtcbiAgICAgIGFyY2ggPSBhd2FpdCBnZXRDdXJBcmNoKCk7XG4gICAgfVxuICAgIGV4dCA9IFwiX1wiICsgYXJjaDtcbiAgfVxuICByZXR1cm4gcGF0aC5yZXNvbHZlKGJhc2VEaXIsIGBjaHJvbWVkcml2ZXIke2V4dH1gKTtcbn1cblxuZnVuY3Rpb24gZ2V0RG93bmxvYWRVcmwgKHZlcnNpb24sIHBsYXRmb3JtLCBhcmNoKSB7XG4gIHJldHVybiBgJHtDRF9DRE59LyR7dmVyc2lvbn0vY2hyb21lZHJpdmVyXyR7cGxhdGZvcm19JHthcmNofS56aXBgO1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZVBsYXRmb3JtIChwbGF0Zm9ybSwgYXJjaCkge1xuICBpZiAoIV8uY29udGFpbnMoQ0RfUExBVFMsIHBsYXRmb3JtKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwbGF0Zm9ybTogJHtwbGF0Zm9ybX1gKTtcbiAgfVxuICBpZiAoIV8uY29udGFpbnMoQ0RfQVJDSFMsIGFyY2gpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGFyY2g6ICR7YXJjaH1gKTtcbiAgfVxuICBpZiAoYXJjaCA9PT0gXCI2NFwiICYmIHBsYXRmb3JtICE9PSBcImxpbnV4XCIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJPbmx5IGxpbnV4IGhhcyBhIDY0LWJpdCB2ZXJzaW9uIG9mIENocm9tZWRyaXZlclwiKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsRm9yUGxhdGZvcm0gKHZlcnNpb24sIHBsYXRmb3JtLCBhcmNoKSB7XG4gIHZhbGlkYXRlUGxhdGZvcm0ocGxhdGZvcm0sIGFyY2gpO1xuICBjb25zdCB1cmwgPSBnZXREb3dubG9hZFVybCh2ZXJzaW9uLCBwbGF0Zm9ybSwgYXJjaCk7XG5cbiAgLy8gc2V0IHVwIGEgdGVtcCBmaWxlIHRvIGRvd25sb2FkIHRoZSBjaHJvbWVkcml2ZXIgemlwZmlsZSB0b1xuICBsZXQgYmluYXJ5U3BlYyA9IGBjaHJvbWVkcml2ZXJfJHtwbGF0Zm9ybX0ke2FyY2h9YDtcbiAgbG9nLmluZm8oYE9wZW5pbmcgdGVtcCBmaWxlIHRvIHdyaXRlICR7YmluYXJ5U3BlY30gdG8uLi5gKTtcbiAgbGV0IHRlbXBGaWxlID0gYXdhaXQgdGVtcERpci5vcGVuKHtcbiAgICBwcmVmaXg6IGJpbmFyeVNwZWMsXG4gICAgc3VmZml4OiAnLnppcCdcbiAgfSk7XG5cbiAgLy8gYWN0dWFsbHkgZG93bmxvYWQgdGhlIHppcGZpbGUgYW5kIHdyaXRlIGl0IHdpdGggYXBwcm9wcmlhdGUgcGVybXNcbiAgbG9nLmluZm8oYERvd25sb2FkaW5nICR7dXJsfS4uLmApO1xuICBsZXQgYm9keSA9IGF3YWl0IHJlcXVlc3QuZ2V0KHt1cmwsIGVuY29kaW5nOiAnYmluYXJ5J30pO1xuICBsb2cuaW5mbyhgV3JpdGluZyBiaW5hcnkgY29udGVudCB0byAke3RlbXBGaWxlLnBhdGh9Li4uYCk7XG4gIGF3YWl0IHdyaXRlRmlsZSh0ZW1wRmlsZS5wYXRoLCBib2R5LCB7ZW5jb2Rpbmc6ICdiaW5hcnknfSk7XG4gIGF3YWl0IGNobW9kKHRlbXBGaWxlLnBhdGgsIDBvMDY0NCk7XG5cbiAgLy8gZXh0cmFjdCBkb3dubG9hZGVkIHppcGZpbGUgdG8gdGVtcGRpclxuICBsZXQgdGVtcFVuemlwcGVkID0gcGF0aC5yZXNvbHZlKHBhdGguZGlybmFtZSh0ZW1wRmlsZS5wYXRoKSwgYmluYXJ5U3BlYyk7XG4gIGxvZy5pbmZvKGBFeHRyYWN0aW5nICR7dGVtcEZpbGUucGF0aH0gdG8gJHt0ZW1wVW56aXBwZWR9YCk7XG4gIGF3YWl0IG1rZGlyKHRlbXBVbnppcHBlZCk7XG4gIGxldCB6aXAgPSBuZXcgQWRtWmlwKHRlbXBGaWxlLnBhdGgpO1xuICB6aXAuZXh0cmFjdEFsbFRvKHRlbXBVbnppcHBlZCwgdHJ1ZSk7XG4gIGxldCBleHRyYWN0ZWRCaW4gPSBwYXRoLnJlc29sdmUodGVtcFVuemlwcGVkLCBcImNocm9tZWRyaXZlclwiKTtcbiAgaWYgKHBsYXRmb3JtID09PSBcIndpblwiKSB7XG4gICAgZXh0cmFjdGVkQmluICs9IFwiLmV4ZVwiO1xuICB9XG5cbiAgLy8gbWFrZSBidWlsZCBkaXJzIHRoYXQgd2lsbCBob2xkIHRoZSBjaHJvbWVkcml2ZXIgYmluYXJ5XG4gIGxvZy5pbmZvKGBDcmVhdGluZyAke3BhdGgucmVzb2x2ZShDRF9CQVNFX0RJUiwgcGxhdGZvcm0pfS4uLmApO1xuICBhd2FpdCBta2RpcnAoQ0RfQkFTRV9ESVIpO1xuICBhd2FpdCBta2RpcnAocGF0aC5yZXNvbHZlKENEX0JBU0VfRElSLCBwbGF0Zm9ybSkpO1xuXG4gIC8vIGNvcHkgdGhlIGV4dHJhY3RlZCBiaW5hcnkgdG8gdGhlIGNvcnJlY3QgYnVpbGQgZGlyXG4gIGxldCBuZXdCaW4gPSBhd2FpdCBnZXRDaHJvbWVkcml2ZXJCaW5hcnlQYXRoKHBsYXRmb3JtLCBhcmNoKTtcbiAgbG9nLmluZm8oYENvcHlpbmcgdW56aXBwZWQgYmluYXJ5LCByZWFkaW5nIGZyb20gJHtleHRyYWN0ZWRCaW59Li4uYCk7XG4gIGxldCBiaW5Db250ZW50cyA9IGF3YWl0IHJlYWRGaWxlKGV4dHJhY3RlZEJpbiwge2VuY29kaW5nOiAnYmluYXJ5J30pO1xuICBsb2cuaW5mbyhgV3JpdGluZyB0byAke25ld0Jpbn0uLi5gKTtcbiAgYXdhaXQgd3JpdGVGaWxlKG5ld0JpbiwgYmluQ29udGVudHMsIHtlbmNvZGluZzogJ2JpbmFyeScsIG1vZGU6IDBvNzU1fSk7XG4gIGxvZy5pbmZvKGAke25ld0Jpbn0gc3VjY2Vzc2Z1bGx5IHB1dCBpbiBwbGFjZWApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsICgpIHtcbiAgbGV0IGFyY2ggPSBhd2FpdCBnZXRDdXJBcmNoKCksIHBsYXRmb3JtID0gZ2V0Q3VyUGxhdGZvcm0oKTtcbiAgaWYgKHBsYXRmb3JtICE9PSBcImxpbnV4XCIgJiYgYXJjaCA9PT0gXCI2NFwiKSB7XG4gICAgYXJjaCA9IFwiMzJcIjtcbiAgfVxuICBhd2FpdCBpbnN0YWxsRm9yUGxhdGZvcm0oQ0RfVkVSLCBwbGF0Zm9ybSwgYXJjaCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbmRpdGlvbmFsSW5zdGFsbCAoKSB7XG4gIGxldCBhcmNoID0gYXdhaXQgZ2V0Q3VyQXJjaCgpLCBwbGF0Zm9ybSA9IGdldEN1clBsYXRmb3JtKCk7XG4gIGlmIChwbGF0Zm9ybSAhPT0gXCJsaW51eFwiICYmIGFyY2ggPT09IFwiNjRcIikge1xuICAgIGFyY2ggPSBcIjMyXCI7XG4gIH1cbiAgbGV0IGJpblBhdGggPSBhd2FpdCBnZXRDaHJvbWVkcml2ZXJCaW5hcnlQYXRoKHBsYXRmb3JtLCBhcmNoKTtcbiAgaWYgKCEoYXdhaXQgZXhpc3RzKGJpblBhdGgpKSkge1xuICAgIGF3YWl0IGluc3RhbGxGb3JQbGF0Zm9ybShDRF9WRVIsIHBsYXRmb3JtLCBhcmNoKTtcbiAgfSBlbHNlIHtcbiAgICBsb2cuaW5mbyhgTm8gbmVlZCB0byBpbnN0YWxsIGNocm9tZWRyaXZlciwgJHtiaW5QYXRofSBleGlzdHNgKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsQWxsICgpIHtcbiAgY29uc3QgcGxhdHMgPSBbXG4gICAgWydsaW51eCcsICczMiddLFxuICAgIFsnbGludXgnLCAnNjQnXSxcbiAgICBbJ3dpbicsICczMiddLFxuICAgIFsnbWFjJywgJzMyJ11cbiAgXTtcbiAgbGV0IGRvd25sb2FkcyA9IFtdO1xuICBmb3IgKGxldCBbcGxhdGZvcm0sIGFyY2hdIG9mIHBsYXRzKSB7XG4gICAgZG93bmxvYWRzLnB1c2goaW5zdGFsbEZvclBsYXRmb3JtKENEX1ZFUiwgcGxhdGZvcm0sIGFyY2gpKTtcbiAgfVxuICBhd2FpdCBsbChkb3dubG9hZHMpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkb0luc3RhbGwgKCkge1xuICBpZiAoXy5jb250YWlucyhwcm9jZXNzLmFyZ3YsICctLWFsbCcpKSB7XG4gICAgYXdhaXQgaW5zdGFsbEFsbCgpO1xuICB9IGVsc2UgaWYgKF8uY29udGFpbnMocHJvY2Vzcy5hcmd2LCAnLS1jb25kaXRpb25hbCcpKSB7XG4gICAgYXdhaXQgY29uZGl0aW9uYWxJbnN0YWxsKCk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgaW5zdGFsbCgpO1xuICB9XG59XG5cbmV4cG9ydCB7IGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgsIGluc3RhbGwsIGluc3RhbGxBbGwsIENEX0JBU0VfRElSLFxuICAgICAgICAgZ2V0Q3VyUGxhdGZvcm0sIGNvbmRpdGlvbmFsSW5zdGFsbCwgZG9JbnN0YWxsfTtcbiJdfQ==