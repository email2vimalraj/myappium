'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumLogger = require('appium-logger');

var _appiumSupport = require('appium-support');

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _jsonwpStatus = require('jsonwp-status');

var _jsonwpStatus2 = _interopRequireDefault(_jsonwpStatus);

var log = (0, _appiumLogger.getLogger)('JSONWP Proxy');

var JWProxy = (function () {
  function JWProxy() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, JWProxy);

    _Object$assign(this, {
      scheme: 'http',
      server: 'localhost',
      port: 4444,
      base: '/wd/hub',
      sessionId: null
    }, opts);
    this.scheme = this.scheme.toLowerCase();
  }

  // abstract the call behind a member function
  // so that we can mock it in tests

  _createClass(JWProxy, [{
    key: 'request',
    value: function request() {
      var args$2$0 = arguments;
      return _regeneratorRuntime.async(function request$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(_requestPromise2['default'].apply(undefined, args$2$0));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'endpointRequiresSessionId',
    value: function endpointRequiresSessionId(endpoint) {
      return !_lodash2['default'].contains(['/session', '/sessions', '/status'], endpoint);
    }
  }, {
    key: 'getUrlForProxy',
    value: function getUrlForProxy(url) {
      if (url === '') {
        url = '/';
      }
      var proxyBase = this.scheme + '://' + this.server + ':' + this.port + this.base;
      var endpointRe = '(/(session|status))';
      var remainingUrl = '';
      if (/^http/.test(url)) {
        var first = new RegExp('(https?://.+)' + endpointRe).exec(url);
        if (!first) {
          throw new Error('Got a complete url but could not extract JWP endpoint');
        }
        remainingUrl = url.replace(first[1], '');
      } else if (new RegExp('^/').test(url)) {
        remainingUrl = url;
      } else {
        throw new Error('Did not know what to do with url \'' + url + '\'');
      }

      var stripPrefixRe = new RegExp('^.+(/(session|status).*)$');
      if (stripPrefixRe.test(remainingUrl)) {
        remainingUrl = stripPrefixRe.exec(remainingUrl)[1];
      }

      if (!new RegExp(endpointRe).test(remainingUrl)) {
        remainingUrl = '/session/' + this.sessionId + remainingUrl;
      }

      var requiresSessionId = this.endpointRequiresSessionId(remainingUrl);

      if (requiresSessionId && this.sessionId === null) {
        throw new Error('Trying to proxy a session command without session id');
      }

      var sessionBaseRe = new RegExp('^/session/([^/]+)');
      if (sessionBaseRe.test(remainingUrl)) {
        // we have something like /session/:id/foobar, so we need to replace
        // the session id
        var match = sessionBaseRe.exec(remainingUrl);
        remainingUrl = remainingUrl.replace(match[1], this.sessionId);
      } else if (requiresSessionId) {
        throw new Error('Could not find :session section for url: ' + remainingUrl);
      }
      remainingUrl = remainingUrl.replace(/\/$/, ''); // can't have trailing slashes
      return proxyBase + remainingUrl;
    }
  }, {
    key: 'proxy',
    value: function proxy(url, method) {
      var body = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];
      var newUrl, reqOpts, res, resBody;
      return _regeneratorRuntime.async(function proxy$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            method = method.toUpperCase();
            newUrl = this.getUrlForProxy(url);
            reqOpts = {
              url: newUrl,
              method: method,
              headers: { 'Content-type': 'application/json;charset=UTF=8' },
              resolveWithFullResponse: true
            };

            if (body !== null) {
              if (typeof body !== 'object') {
                body = JSON.parse(body);
              }
              reqOpts.json = body;
            }
            log.info('Proxying [' + method + ' ' + (url || "/") + '] to [' + method + ' ' + newUrl + '] ' + (body ? 'with body: ' + _lodash2['default'].trunc(JSON.stringify(body), 200) : 'with no body'));
            res = undefined, resBody = undefined;
            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.request(reqOpts));

          case 9:
            res = context$2$0.sent;

            resBody = res.body;
            log.info('Got response with status ' + res.statusCode + ': ' + _lodash2['default'].trunc(JSON.stringify(resBody), 200));
            if (/\/session$/.test(url) && method === 'POST') {
              if (res.statusCode === 200) {
                this.sessionId = resBody.sessionId;
              } else if (res.statusCode === 303) {
                this.sessionId = /\/session\/([^\/]+)/.exec(resBody)[1];
              }
            }
            context$2$0.next = 18;
            break;

          case 15:
            context$2$0.prev = 15;
            context$2$0.t0 = context$2$0['catch'](6);
            throw new Error('Could not proxy command to remote server. ' + ('Original error: ' + context$2$0.t0.message));

          case 18:
            return context$2$0.abrupt('return', [res, resBody]);

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6, 15]]);
    }
  }, {
    key: 'command',
    value: function command(url, method) {
      var body = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];

      var _ref, _ref2, response, resBody, statusCodesWithRes, message, e;

      return _regeneratorRuntime.async(function command$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.proxy(url, method, body));

          case 2:
            _ref = context$2$0.sent;
            _ref2 = _slicedToArray(_ref, 2);
            response = _ref2[0];
            resBody = _ref2[1];
            statusCodesWithRes = [100, 200, 500];

            resBody = _appiumSupport.util.safeJsonParse(resBody);

            if (!(_lodash2['default'].contains(statusCodesWithRes, response.statusCode) && (_lodash2['default'].isUndefined(resBody.status) || _lodash2['default'].isUndefined(resBody.value)))) {
              context$2$0.next = 10;
              break;
            }

            throw new Error('Did not get a valid response object. Object was: ' + JSON.stringify(resBody));

          case 10:
            if (!_lodash2['default'].contains(statusCodesWithRes, response.statusCode)) {
              context$2$0.next = 24;
              break;
            }

            if (!(response.statusCode === 200 && resBody.status === 0)) {
              context$2$0.next = 15;
              break;
            }

            return context$2$0.abrupt('return', resBody.value);

          case 15:
            if (!(response.statusCode === 200 && _lodash2['default'].isUndefined(resBody.status))) {
              context$2$0.next = 17;
              break;
            }

            return context$2$0.abrupt('return', resBody);

          case 17:
            message = _jsonwpStatus2['default'].getSummaryByCode(resBody.status);

            if (resBody.value.message) {
              message += ' (Original error: ' + resBody.value.message + ')';
            }
            e = new Error(message);

            e.status = resBody.status;
            e.value = resBody.value;
            e.httpCode = response.statusCode;
            throw e;

          case 24:
            throw new Error('Didn\'t know what to do with response code \'' + response.statusCode + '\'');

          case 25:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getSessionIdFromUrl',
    value: function getSessionIdFromUrl(url) {
      var match = url.match(/\/session\/([^\/]+)/);
      return match ? match[1] : null;
    }
  }, {
    key: 'proxyReqRes',
    value: function proxyReqRes(req, res) {
      var _ref3, _ref32, response, body, reqSessionId;

      return _regeneratorRuntime.async(function proxyReqRes$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.proxy(req.originalUrl, req.method, req.body));

          case 2:
            _ref3 = context$2$0.sent;
            _ref32 = _slicedToArray(_ref3, 2);
            response = _ref32[0];
            body = _ref32[1];

            res.headers = response.headers;
            res.set('Content-type', response.headers['content-type']);
            // if the proxied response contains a sessionId that the downstream
            // driver has generated, we don't want to return that to the client.
            // Instead, return the id from the request or from current session
            body = _appiumSupport.util.safeJsonParse(body);
            if (body && body.sessionId) {
              reqSessionId = this.getSessionIdFromUrl(req.originalUrl);

              if (reqSessionId) {
                log.info('Replacing sessionId ' + body.sessionId + ' with ' + reqSessionId);
                body.sessionId = reqSessionId;
              } else if (this.sessionId) {
                log.info('Replacing sessionId ' + body.sessionId + ' with ' + this.sessionId);
                body.sessionId = this.sessionId;
              }
            }
            res.status(response.statusCode).send(JSON.stringify(body));

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return JWProxy;
})();

exports['default'] = JWProxy;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,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WUFBWSxDQUFDO2VBQy9CLE1BQU0sSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO0FBQ3pCLG1CQUFHLENBQUMsSUFBSSwwQkFBd0IsSUFBSSxDQUFDLFNBQVMsY0FBUyxJQUFJLENBQUMsU0FBUyxDQUFHLENBQUM7QUFDekUsb0JBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztlQUNqQzthQUNGO0FBQ0QsZUFBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzs7Ozs7OztLQUM1RDs7O1NBNUpHLE9BQU87OztxQkErSkUsT0FBTyIsImZpbGUiOiJsaWIvcHJveHkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZ2V0TG9nZ2VyIH0gZnJvbSAnYXBwaXVtLWxvZ2dlcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCBqd3BTdGF0dXMgZnJvbSAnanNvbndwLXN0YXR1cyc7XG5cblxuY29uc3QgbG9nID0gZ2V0TG9nZ2VyKCdKU09OV1AgUHJveHknKTtcblxuY2xhc3MgSldQcm94eSB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIHtcbiAgICAgIHNjaGVtZTogJ2h0dHAnLFxuICAgICAgc2VydmVyOiAnbG9jYWxob3N0JyxcbiAgICAgIHBvcnQ6IDQ0NDQsXG4gICAgICBiYXNlOiAnL3dkL2h1YicsXG4gICAgICBzZXNzaW9uSWQ6IG51bGxcbiAgICB9LCBvcHRzKTtcbiAgICB0aGlzLnNjaGVtZSA9IHRoaXMuc2NoZW1lLnRvTG93ZXJDYXNlKCk7XG4gIH1cblxuICAvLyBhYnN0cmFjdCB0aGUgY2FsbCBiZWhpbmQgYSBtZW1iZXIgZnVuY3Rpb25cbiAgLy8gc28gdGhhdCB3ZSBjYW4gbW9jayBpdCBpbiB0ZXN0c1xuICBhc3luYyByZXF1ZXN0ICguLi5hcmdzKSB7XG4gICAgcmV0dXJuIGF3YWl0IHJlcXVlc3QoLi4uYXJncyk7XG4gIH1cblxuICBlbmRwb2ludFJlcXVpcmVzU2Vzc2lvbklkIChlbmRwb2ludCkge1xuICAgIHJldHVybiAhXy5jb250YWlucyhbJy9zZXNzaW9uJywgJy9zZXNzaW9ucycsICcvc3RhdHVzJ10sIGVuZHBvaW50KTtcbiAgfVxuXG4gIGdldFVybEZvclByb3h5ICh1cmwpIHtcbiAgICBpZiAodXJsID09PSAnJykge1xuICAgICAgdXJsID0gJy8nO1xuICAgIH1cbiAgICBjb25zdCBwcm94eUJhc2UgPSBgJHt0aGlzLnNjaGVtZX06Ly8ke3RoaXMuc2VydmVyfToke3RoaXMucG9ydH0ke3RoaXMuYmFzZX1gO1xuICAgIGNvbnN0IGVuZHBvaW50UmUgPSAnKC8oc2Vzc2lvbnxzdGF0dXMpKSc7XG4gICAgbGV0IHJlbWFpbmluZ1VybCA9ICcnO1xuICAgIGlmICgvXmh0dHAvLnRlc3QodXJsKSkge1xuICAgICAgY29uc3QgZmlyc3QgPSAobmV3IFJlZ0V4cChgKGh0dHBzPzovLy4rKSR7ZW5kcG9pbnRSZX1gKSkuZXhlYyh1cmwpO1xuICAgICAgaWYgKCFmaXJzdCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dvdCBhIGNvbXBsZXRlIHVybCBidXQgY291bGQgbm90IGV4dHJhY3QgSldQIGVuZHBvaW50Jyk7XG4gICAgICB9XG4gICAgICByZW1haW5pbmdVcmwgPSB1cmwucmVwbGFjZShmaXJzdFsxXSwgJycpO1xuICAgIH0gZWxzZSBpZiAoKG5ldyBSZWdFeHAoJ14vJykpLnRlc3QodXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gdXJsO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYERpZCBub3Qga25vdyB3aGF0IHRvIGRvIHdpdGggdXJsICcke3VybH0nYCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RyaXBQcmVmaXhSZSA9IG5ldyBSZWdFeHAoJ14uKygvKHNlc3Npb258c3RhdHVzKS4qKSQnKTtcbiAgICBpZiAoc3RyaXBQcmVmaXhSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHN0cmlwUHJlZml4UmUuZXhlYyhyZW1haW5pbmdVcmwpWzFdO1xuICAgIH1cblxuICAgIGlmICghKG5ldyBSZWdFeHAoZW5kcG9pbnRSZSkpLnRlc3QocmVtYWluaW5nVXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gYC9zZXNzaW9uLyR7dGhpcy5zZXNzaW9uSWR9JHtyZW1haW5pbmdVcmx9YDtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1aXJlc1Nlc3Npb25JZCA9IHRoaXMuZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZChyZW1haW5pbmdVcmwpO1xuXG4gICAgaWYgKHJlcXVpcmVzU2Vzc2lvbklkICYmIHRoaXMuc2Vzc2lvbklkID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyeWluZyB0byBwcm94eSBhIHNlc3Npb24gY29tbWFuZCB3aXRob3V0IHNlc3Npb24gaWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBzZXNzaW9uQmFzZVJlID0gbmV3IFJlZ0V4cCgnXi9zZXNzaW9uLyhbXi9dKyknKTtcbiAgICBpZiAoc2Vzc2lvbkJhc2VSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIC8vIHdlIGhhdmUgc29tZXRoaW5nIGxpa2UgL3Nlc3Npb24vOmlkL2Zvb2Jhciwgc28gd2UgbmVlZCB0byByZXBsYWNlXG4gICAgICAvLyB0aGUgc2Vzc2lvbiBpZFxuICAgICAgY29uc3QgbWF0Y2ggPSBzZXNzaW9uQmFzZVJlLmV4ZWMocmVtYWluaW5nVXJsKTtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHJlbWFpbmluZ1VybC5yZXBsYWNlKG1hdGNoWzFdLCB0aGlzLnNlc3Npb25JZCk7XG4gICAgfSBlbHNlIGlmIChyZXF1aXJlc1Nlc3Npb25JZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCA6c2Vzc2lvbiBzZWN0aW9uIGZvciB1cmw6ICR7cmVtYWluaW5nVXJsfWApO1xuICAgIH1cbiAgICByZW1haW5pbmdVcmwgPSByZW1haW5pbmdVcmwucmVwbGFjZSgvXFwvJC8sICcnKTsgLy8gY2FuJ3QgaGF2ZSB0cmFpbGluZyBzbGFzaGVzXG4gICAgcmV0dXJuIHByb3h5QmFzZSArIHJlbWFpbmluZ1VybDtcbiAgfVxuXG4gIGFzeW5jIHByb3h5ICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBtZXRob2QgPSBtZXRob2QudG9VcHBlckNhc2UoKTtcbiAgICBjb25zdCBuZXdVcmwgPSB0aGlzLmdldFVybEZvclByb3h5KHVybCk7XG4gICAgY29uc3QgcmVxT3B0cyA9IHtcbiAgICAgIHVybDogbmV3VXJsLFxuICAgICAgbWV0aG9kLFxuICAgICAgaGVhZGVyczogeydDb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PVVURj04J30sXG4gICAgICByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZVxuICAgIH07XG4gICAgaWYgKGJvZHkgIT09IG51bGwpIHtcbiAgICAgIGlmICh0eXBlb2YgYm9keSAhPT0gJ29iamVjdCcpIHtcbiAgICAgICAgYm9keSA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgICB9XG4gICAgICByZXFPcHRzLmpzb24gPSBib2R5O1xuICAgIH1cbiAgICBsb2cuaW5mbyhgUHJveHlpbmcgWyR7bWV0aG9kfSAke3VybCB8fCBcIi9cIn1dIHRvIFske21ldGhvZH0gJHtuZXdVcmx9XSBgICtcbiAgICAgICAgICAgICAoYm9keSA/IGB3aXRoIGJvZHk6ICR7Xy50cnVuYyhKU09OLnN0cmluZ2lmeShib2R5KSwgMjAwKX1gIDogJ3dpdGggbm8gYm9keScpKTtcbiAgICBsZXQgcmVzLCByZXNCb2R5O1xuICAgIHRyeSB7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLnJlcXVlc3QocmVxT3B0cyk7XG4gICAgICByZXNCb2R5ID0gcmVzLmJvZHk7XG4gICAgICBsb2cuaW5mbyhgR290IHJlc3BvbnNlIHdpdGggc3RhdHVzICR7cmVzLnN0YXR1c0NvZGV9OiAke18udHJ1bmMoSlNPTi5zdHJpbmdpZnkocmVzQm9keSksIDIwMCl9YCk7XG4gICAgICBpZiAoL1xcL3Nlc3Npb24kLy50ZXN0KHVybCkgJiYgbWV0aG9kID09PSAnUE9TVCcpIHtcbiAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlID09PSAyMDApIHtcbiAgICAgICAgICB0aGlzLnNlc3Npb25JZCA9IHJlc0JvZHkuc2Vzc2lvbklkO1xuICAgICAgICB9IGVsc2UgaWYgKHJlcy5zdGF0dXNDb2RlID09PSAzMDMpIHtcbiAgICAgICAgICB0aGlzLnNlc3Npb25JZCA9IC9cXC9zZXNzaW9uXFwvKFteXFwvXSspLy5leGVjKHJlc0JvZHkpWzFdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgcHJveHkgY29tbWFuZCB0byByZW1vdGUgc2VydmVyLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgICByZXR1cm4gW3JlcywgcmVzQm9keV07XG4gIH1cblxuICBhc3luYyBjb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBsZXQgW3Jlc3BvbnNlLCByZXNCb2R5XSA9IGF3YWl0IHRoaXMucHJveHkodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIGxldCBzdGF0dXNDb2Rlc1dpdGhSZXMgPSBbMTAwLCAyMDAsIDUwMF07XG4gICAgcmVzQm9keSA9IHV0aWwuc2FmZUpzb25QYXJzZShyZXNCb2R5KTtcbiAgICBpZiAoXy5jb250YWlucyhzdGF0dXNDb2Rlc1dpdGhSZXMsIHJlc3BvbnNlLnN0YXR1c0NvZGUpICYmXG4gICAgICAgIChfLmlzVW5kZWZpbmVkKHJlc0JvZHkuc3RhdHVzKSB8fCBfLmlzVW5kZWZpbmVkKHJlc0JvZHkudmFsdWUpKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBEaWQgbm90IGdldCBhIHZhbGlkIHJlc3BvbnNlIG9iamVjdC4gT2JqZWN0IHdhczogJHtKU09OLnN0cmluZ2lmeShyZXNCb2R5KX1gKTtcbiAgICB9XG4gICAgaWYgKF8uY29udGFpbnMoc3RhdHVzQ29kZXNXaXRoUmVzLCByZXNwb25zZS5zdGF0dXNDb2RlKSkge1xuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCAmJiByZXNCb2R5LnN0YXR1cyA9PT0gMCkge1xuICAgICAgICByZXR1cm4gcmVzQm9keS52YWx1ZTtcbiAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwICYmIF8uaXNVbmRlZmluZWQocmVzQm9keS5zdGF0dXMpKSB7XG4gICAgICAgIHJldHVybiByZXNCb2R5O1xuICAgICAgfVxuICAgICAgbGV0IG1lc3NhZ2UgPSBqd3BTdGF0dXMuZ2V0U3VtbWFyeUJ5Q29kZShyZXNCb2R5LnN0YXR1cyk7XG4gICAgICBpZiAocmVzQm9keS52YWx1ZS5tZXNzYWdlKSB7XG4gICAgICAgIG1lc3NhZ2UgKz0gYCAoT3JpZ2luYWwgZXJyb3I6ICR7cmVzQm9keS52YWx1ZS5tZXNzYWdlfSlgO1xuICAgICAgfVxuICAgICAgbGV0IGUgPSBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgICBlLnN0YXR1cyA9IHJlc0JvZHkuc3RhdHVzO1xuICAgICAgZS52YWx1ZSA9IHJlc0JvZHkudmFsdWU7XG4gICAgICBlLmh0dHBDb2RlID0gcmVzcG9uc2Uuc3RhdHVzQ29kZTtcbiAgICAgIHRocm93IGU7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihgRGlkbid0IGtub3cgd2hhdCB0byBkbyB3aXRoIHJlc3BvbnNlIGNvZGUgJyR7cmVzcG9uc2Uuc3RhdHVzQ29kZX0nYCk7XG4gIH1cblxuICBnZXRTZXNzaW9uSWRGcm9tVXJsICh1cmwpIHtcbiAgICBjb25zdCBtYXRjaCA9IHVybC5tYXRjaCgvXFwvc2Vzc2lvblxcLyhbXlxcL10rKS8pO1xuICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogbnVsbDtcbiAgfVxuXG4gIGFzeW5jIHByb3h5UmVxUmVzIChyZXEsIHJlcykge1xuICAgIGxldCBbcmVzcG9uc2UsIGJvZHldID0gYXdhaXQgdGhpcy5wcm94eShyZXEub3JpZ2luYWxVcmwsIHJlcS5tZXRob2QsIHJlcS5ib2R5KTtcbiAgICByZXMuaGVhZGVycyA9IHJlc3BvbnNlLmhlYWRlcnM7XG4gICAgcmVzLnNldCgnQ29udGVudC10eXBlJywgcmVzcG9uc2UuaGVhZGVyc1snY29udGVudC10eXBlJ10pO1xuICAgIC8vIGlmIHRoZSBwcm94aWVkIHJlc3BvbnNlIGNvbnRhaW5zIGEgc2Vzc2lvbklkIHRoYXQgdGhlIGRvd25zdHJlYW1cbiAgICAvLyBkcml2ZXIgaGFzIGdlbmVyYXRlZCwgd2UgZG9uJ3Qgd2FudCB0byByZXR1cm4gdGhhdCB0byB0aGUgY2xpZW50LlxuICAgIC8vIEluc3RlYWQsIHJldHVybiB0aGUgaWQgZnJvbSB0aGUgcmVxdWVzdCBvciBmcm9tIGN1cnJlbnQgc2Vzc2lvblxuICAgIGJvZHkgPSB1dGlsLnNhZmVKc29uUGFyc2UoYm9keSk7XG4gICAgaWYgKGJvZHkgJiYgYm9keS5zZXNzaW9uSWQpIHtcbiAgICAgIGNvbnN0IHJlcVNlc3Npb25JZCA9IHRoaXMuZ2V0U2Vzc2lvbklkRnJvbVVybChyZXEub3JpZ2luYWxVcmwpO1xuICAgICAgaWYgKHJlcVNlc3Npb25JZCkge1xuICAgICAgICBsb2cuaW5mbyhgUmVwbGFjaW5nIHNlc3Npb25JZCAke2JvZHkuc2Vzc2lvbklkfSB3aXRoICR7cmVxU2Vzc2lvbklkfWApO1xuICAgICAgICBib2R5LnNlc3Npb25JZCA9IHJlcVNlc3Npb25JZDtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5zZXNzaW9uSWQpIHtcbiAgICAgICAgbG9nLmluZm8oYFJlcGxhY2luZyBzZXNzaW9uSWQgJHtib2R5LnNlc3Npb25JZH0gd2l0aCAke3RoaXMuc2Vzc2lvbklkfWApO1xuICAgICAgICBib2R5LnNlc3Npb25JZCA9IHRoaXMuc2Vzc2lvbklkO1xuICAgICAgfVxuICAgIH1cbiAgICByZXMuc3RhdHVzKHJlc3BvbnNlLnN0YXR1c0NvZGUpLnNlbmQoSlNPTi5zdHJpbmdpZnkoYm9keSkpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEpXUHJveHk7XG4iXX0=