// Wrapper around Apple's Instruments app

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _toConsumableArray = require('babel-runtime/helpers/to-consumable-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _teen_process = require('teen_process');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _through = require('through');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumIosSimulator = require('appium-ios-simulator');

var _utils = require('./utils');

var _streams = require('./streams');

require('colors');

var ERR_NEVER_CHECKED_IN = 'Instruments never checked in';
var ERR_CRASHED_ON_STARTUP = 'Instruments crashed on startup';

var Instruments = (function () {
  _createClass(Instruments, null, [{
    key: 'quickInstruments',

    // simple factory with sane defaults
    value: function quickInstruments(opts) {
      var xcodeTraceTemplatePath;
      return _regeneratorRuntime.async(function quickInstruments$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            opts = _lodash2['default'].clone(opts);
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumXcode2['default'].getAutomationTraceTemplatePath());

          case 3:
            xcodeTraceTemplatePath = context$2$0.sent;

            _lodash2['default'].defaults(opts, {
              launchTimeout: 60000,
              template: xcodeTraceTemplatePath,
              withoutDelay: true,
              xcodeVersion: '8.1',
              webSocket: null,
              flakeyRetries: 2
            });
            return context$2$0.abrupt('return', new Instruments(opts));

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /*
     * opts:
     *   - app
     *   - termTimeout - defaults to 3000
     *   - flakeyRetries - defaults to 0
     *   - udid
     *   - bootstrap
     *   - template
     *   - withoutDelay
     *   - processArguments
     *   - simulatorSdkAndDevice
     *   - tmpDir - defaults to `/tmp/appium-instruments`
     *   - traceDir
     *   - launchTimeout - defaults to 90000
     *   - webSocket
     *   - instrumentsPath
     */
  }]);

  function Instruments(opts) {
    var _this = this;

    _classCallCheck(this, Instruments);

    opts = _lodash2['default'].cloneDeep(opts);
    _lodash2['default'].defaults(opts, {
      termTimeout: 3000,
      tmpDir: '/tmp/appium-instruments',
      launchTimeout: 90000,
      flakeyRetries: 0
    });

    // config
    var _arr = ['app', 'termTimeout', 'flakeyRetries', 'udid', 'bootstrap', 'template', 'withoutDelay', 'processArguments', 'simulatorSdkAndDevice', 'tmpDir', 'traceDir'];
    for (var _i = 0; _i < _arr.length; _i++) {
      var f = _arr[_i];
      this[f] = opts[f];
    }
    this.traceDir = this.traceDir || this.tmpDir;
    this.launchTimeout = (0, _utils.parseLaunchTimeout)(opts.launchTimeout);

    // state
    this.proc = null;
    this.webSocket = opts.webSocket;
    this.instrumentsPath = opts.instrumentsPath;
    this.launchTries = 0;
    this.socketConnectDelays = [];
    this.gotFBSOpenApplicationError = false;
    this.onShutdown = new _bluebird2['default'](function (resolve, reject) {
      _this.onShutdownDeferred = { resolve: resolve, reject: reject };
    });
    // avoids UnhandledException
    this.onShutdown['catch'](function () {}).done();
  }

  _createClass(Instruments, [{
    key: 'configure',
    value: function configure() {
      return _regeneratorRuntime.async(function configure$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.xcodeVersion) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumXcode2['default'].getVersion(true));

          case 3:
            this.xcodeVersion = context$2$0.sent;

          case 4:
            if (this.xcodeVersion.versionFloat === 6.0 && this.withoutDelay) {
              _logger2['default'].info('In xcode 6.0, instruments-without-delay does not work. ' + 'If using Appium, you can disable instruments-without-delay ' + 'with the --native-instruments-lib server flag');
            }

            if (!(this.xcodeVersion.versionString === '5.0.1')) {
              context$2$0.next = 7;
              break;
            }

            throw new Error('Xcode 5.0.1 ships with a broken version of ' + 'Instruments. please upgrade to 5.0.2');

          case 7:
            if (this.template) {
              context$2$0.next = 11;
              break;
            }

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(_appiumXcode2['default'].getAutomationTraceTemplatePath());

          case 10:
            this.template = context$2$0.sent;

          case 11:
            if (this.instrumentsPath) {
              context$2$0.next = 15;
              break;
            }

            context$2$0.next = 14;
            return _regeneratorRuntime.awrap((0, _utils.getInstrumentsPath)());

          case 14:
            this.instrumentsPath = context$2$0.sent;

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'launchOnce',
    value: function launchOnce() {
      var launchResultPromise, actOnStderr;
      return _regeneratorRuntime.async(function launchOnce$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info('Launching instruments');
            // prepare temp dir
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(this.tmpDir));

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(this.tmpDir));

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(this.traceDir));

          case 7:

            this.exitListener = null;
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.spawnInstruments());

          case 10:
            this.proc = context$2$0.sent;

            this.proc.on('exit', function (code) {
              _logger2['default'].debug('Instruments exited with code ' + code);
            });

            launchResultPromise = new _bluebird2['default'](function (resolve, reject) {
              _this2.launchResultDeferred = { resolve: resolve, reject: reject };
            });

            // There was a special case for ignoreStartupExit
            // but it is not needed anymore, you may just listen for exit.
            this.setExitListener(function () {
              _this2.proc = null;
              _this2.launchResultDeferred.reject(new Error(ERR_CRASHED_ON_STARTUP));
            });

            this.proc.on('error', function (err) {
              _logger2['default'].debug('Error with instruments proc: ' + err.message);
              if (err.message.indexOf('ENOENT') !== -1) {
                _this2.proc = null; // otherwise we'll try to send sigkill
                _logger2['default'].error('Unable to spawn instruments: ' + err.message);
                _this2.launchResultDeferred.reject(err);
              }
            });

            this.proc.stdout.setEncoding('utf8');
            this.proc.stdout.pipe((0, _streams.outputStream)()).pipe((0, _streams.dumpStream)());

            this.proc.stderr.setEncoding('utf8');

            actOnStderr = function actOnStderr(output) {
              if (_this2.launchTimeout.afterSimLaunch && output && output.match(/CLTilesManagerClient: initialize/)) {
                _this2.addSocketConnectTimer(_this2.launchTimeout.afterSimLaunch, 'afterLaunch', function callee$3$0() {
                  return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                    while (1) switch (context$4$0.prev = context$4$0.next) {
                      case 0:
                        context$4$0.next = 2;
                        return _regeneratorRuntime.awrap((0, _utils.killAllInstruments)());

                      case 2:
                      case 'end':
                        return context$4$0.stop();
                    }
                  }, null, _this2);
                });
              }

              var fbsErrStr = '(FBSOpenApplicationErrorDomain error 8.)';
              if (output.indexOf(fbsErrStr) !== -1) {
                _this2.gotFBSOpenApplicationError = true;
              }
            };

            this.proc.stderr.pipe((0, _through.through)(function (output) {
              actOnStderr(output);
              this.queue(output);
            })).pipe((0, _streams.errorStream)()).pipe((0, _streams.webSocketAlertStream)(this.webSocket)).pipe((0, _streams.dumpStream)());

            // start waiting for instruments to launch successfully
            this.addSocketConnectTimer(this.launchTimeout.global, 'global', function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap((0, _utils.killAllInstruments)());

                  case 2:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2);
            });

            context$2$0.prev = 21;
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(launchResultPromise);

          case 24:
            context$2$0.prev = 24;

            this.clearSocketConnectTimers();
            return context$2$0.finish(24);

          case 27:
            this.setExitListener(function (code) {
              _this2.proc = null;
              _this2.onShutdownDeferred.reject(new Error('Abnormal exit with code: ' + code));
            });

          case 28:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[21,, 24, 27]]);
    }
  }, {
    key: 'launch',
    value: function launch() {
      var launchTries, errIsCatchable;
      return _regeneratorRuntime.async(function launch$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.configure());

          case 2:
            launchTries = 0;

          case 3:
            if (launchTries > 0) {
              _logger2['default'].debug('Attempting to retry launching instruments, this is ' + ('retry #' + launchTries));
            }
            context$2$0.prev = 4;

            launchTries++;
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.launchOnce());

          case 8:
            return context$2$0.abrupt('break', 35);

          case 11:
            context$2$0.prev = 11;
            context$2$0.t0 = context$2$0['catch'](4);

            _logger2['default'].debug(context$2$0.t0.message);
            errIsCatchable = context$2$0.t0.message === ERR_NEVER_CHECKED_IN || context$2$0.t0.message === ERR_CRASHED_ON_STARTUP;

            if (!errIsCatchable) {
              context$2$0.next = 33;
              break;
            }

            if (!(launchTries < this.flakeyRetries + 1)) {
              context$2$0.next = 30;
              break;
            }

            if (!this.gotFBSOpenApplicationError) {
              context$2$0.next = 24;
              break;
            }

            _logger2['default'].debug('Got the FBSOpenApplicationError, not killing the ' + 'sim but leaving it open so the app will launch');
            this.gotFBSOpenApplicationError = false; // clear out for next launch
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(1000));

          case 22:
            context$2$0.next = 28;
            break;

          case 24:
            context$2$0.next = 26;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.killAllSimulators)());

          case 26:
            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(5000));

          case 28:
            context$2$0.next = 31;
            break;

          case 30:
            _logger2['default'].errorAndThrow('We exceeded the number of retries allowed for ' + 'instruments to successfully start; failing launch');

          case 31:
            context$2$0.next = 34;
            break;

          case 33:
            throw context$2$0.t0;

          case 34:
            if (true) {
              context$2$0.next = 3;
              break;
            }

          case 35:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[4, 11]]);
    }
  }, {
    key: 'registerLaunch',
    value: function registerLaunch() {
      this.launchResultDeferred.resolve();
    }
  }, {
    key: 'spawnInstruments',
    value: function spawnInstruments() {
      var traceDir, i, args, env, iwdPath, instrumentsExecArgs;
      return _regeneratorRuntime.async(function spawnInstruments$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            traceDir = undefined;
            i = 0;

          case 2:
            // loop while there are tracedirs to delete
            traceDir = _path2['default'].resolve(this.traceDir, 'instrumentscli' + i + '.trace');
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(traceDir));

          case 5:
            if (context$2$0.sent) {
              context$2$0.next = 7;
              break;
            }

            return context$2$0.abrupt('break', 10);

          case 7:
            i++;
            context$2$0.next = 2;
            break;

          case 10:
            args = ['-t', this.template, '-D', traceDir];

            if (this.udid) {
              args = args.concat(['-w', this.udid]);
              _logger2['default'].debug('Attempting to run app on real device with UDID ' + this.udid);
            }
            if (!this.udid && this.simulatorSdkAndDevice) {
              args = args.concat(['-w', this.simulatorSdkAndDevice]);
              _logger2['default'].debug('Attempting to run app on ' + this.simulatorSdkAndDevice);
            }
            args = args.concat([this.app]);
            if (this.processArguments) {
              args = args.concat(this.processArguments);
              _logger2['default'].debug('Attempting to run app with process arguments: ' + JSON.stringify(this.processArguments));
            }
            args = args.concat(['-e', 'UIASCRIPT', this.bootstrap]);
            args = args.concat(['-e', 'UIARESULTSPATH', this.tmpDir]);
            env = _lodash2['default'].clone(process.env);
            context$2$0.next = 20;
            return _regeneratorRuntime.awrap((0, _utils.getIwdPath)(this.xcodeVersion.major));

          case 20:
            iwdPath = context$2$0.sent;

            env.CA_DEBUG_TRANSACTIONS = 1;
            if (this.withoutDelay && !this.udid) {
              env.DYLD_INSERT_LIBRARIES = _path2['default'].resolve(iwdPath, 'InstrumentsShim.dylib');
              env.LIB_PATH = iwdPath;
            }
            instrumentsExecArgs = [this.instrumentsPath].concat(_toConsumableArray(_lodash2['default'].clone(args)));

            instrumentsExecArgs = _lodash2['default'].map(instrumentsExecArgs, function (arg) {
              if (arg === null) {
                throw new Error('A null value was passed as an arg to execute ' + 'instruments on the command line. A letiable is ' + 'probably not getting set. Array of command args: ' + JSON.stringify(instrumentsExecArgs));
              }
              if (_lodash2['default'].isString(arg) && arg.indexOf(' ') !== -1) {
                return '"' + arg + '"';
              }
              return arg;
            });
            _logger2['default'].debug('Spawning instruments with command: ' + instrumentsExecArgs.join(' '));
            _logger2['default'].debug('And extra without-delay env: ' + JSON.stringify({
              DYLD_INSERT_LIBRARIES: env.DYLD_INSERT_LIBRARIES,
              LIB_PATH: env.LIB_PATH
            }));
            _logger2['default'].debug('And launch timeouts (in ms): ' + JSON.stringify(this.launchTimeout));
            context$2$0.next = 30;
            return _regeneratorRuntime.awrap((0, _teen_process.spawn)(this.instrumentsPath, args, { env: env }));

          case 30:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 31:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'addSocketConnectTimer',
    value: function addSocketConnectTimer(delay, type, doAction) {
      var _this3 = this;

      var socketConnectDelay = (0, _appiumSupport.cancellableDelay)(delay);
      socketConnectDelay.then(function () {
        _logger2['default'].warn('Instruments socket client never checked in; timing out (' + type + ')');
        _this3.setExitListener(function () {
          _this3.proc = null;
          _this3.launchResultDeferred.reject(new Error(ERR_NEVER_CHECKED_IN));
        });
        return doAction();
      })['catch'](_bluebird2['default'].CancellationError, function () {}).done();
      this.socketConnectDelays.push(socketConnectDelay);
    }
  }, {
    key: 'clearSocketConnectTimers',
    value: function clearSocketConnectTimers() {
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = _getIterator(this.socketConnectDelays), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          var delay = _step.value;

          delay.cancel();
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      this.socketConnectDelays = [];
    }
  }, {
    key: 'setExitListener',
    value: function setExitListener(exitListener) {
      if (!this.proc) return;
      if (this.exitListener) {
        this.proc.removeListener('exit', this.exitListener);
      }
      this.exitListener = exitListener;
      this.proc.on('exit', exitListener);
    }

    /* PROCESS MANAGEMENT */
  }, {
    key: 'shutdown',
    value: function shutdown() {
      return _regeneratorRuntime.async(function shutdown$(context$2$0) {
        var _this5 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.proc) {
              context$2$0.next = 3;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((function callee$2$0() {
              var wasTerminated, termDelay, termPromise;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this4 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    _logger2['default'].debug('Starting shutdown.');
                    wasTerminated = false;
                    termDelay = (0, _appiumSupport.cancellableDelay)(this.termTimeout);
                    termPromise = termDelay['catch'](_bluebird2['default'].CancellationError, function () {});

                    this.setExitListener(function () {
                      _this4.proc = null;
                      wasTerminated = true;
                      termDelay.cancel();
                      _this4.onShutdownDeferred.resolve();
                    });
                    _logger2['default'].debug('Sending sigterm to instruments');
                    this.proc.kill('SIGTERM');
                    context$3$0.next = 9;
                    return _regeneratorRuntime.awrap(termPromise);

                  case 9:
                    if (wasTerminated) {
                      context$3$0.next = 11;
                      break;
                    }

                    throw new Error('Instruments did not terminate after ' + this.termTimeout / 1000 + ' seconds!');

                  case 11:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this5);
            })());

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return Instruments;
})();

exports['default'] = Instruments;
module.exports = exports['default'];

// monitoring process termination
//# sourceMappingURL=data:application/json;base64,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RyxXQUFXOzs7cUJBa1RGLFdBQVciLCJmaWxlIjoibGliL2luc3RydW1lbnRzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gV3JhcHBlciBhcm91bmQgQXBwbGUncyBJbnN0cnVtZW50cyBhcHBcblxuaW1wb3J0IHsgc3Bhd24gfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgdGhyb3VnaCB9IGZyb20gJ3Rocm91Z2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBta2RpcnAsIGZzLCBjYW5jZWxsYWJsZURlbGF5IH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHhjb2RlIGZyb20gJ2FwcGl1bS14Y29kZSc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBraWxsQWxsU2ltdWxhdG9ycyB9IGZyb20gJ2FwcGl1bS1pb3Mtc2ltdWxhdG9yJztcbmltcG9ydCB7IGtpbGxBbGxJbnN0cnVtZW50cywgZ2V0SW5zdHJ1bWVudHNQYXRoLCBwYXJzZUxhdW5jaFRpbWVvdXQsXG4gICAgICAgICBnZXRJd2RQYXRoIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgeyBvdXRwdXRTdHJlYW0sIGVycm9yU3RyZWFtLCB3ZWJTb2NrZXRBbGVydFN0cmVhbSwgZHVtcFN0cmVhbSB9IGZyb20gJy4vc3RyZWFtcyc7XG5pbXBvcnQgJ2NvbG9ycyc7XG5cblxuY29uc3QgRVJSX05FVkVSX0NIRUNLRURfSU4gPSAnSW5zdHJ1bWVudHMgbmV2ZXIgY2hlY2tlZCBpbic7XG5jb25zdCBFUlJfQ1JBU0hFRF9PTl9TVEFSVFVQID0gJ0luc3RydW1lbnRzIGNyYXNoZWQgb24gc3RhcnR1cCc7XG5cbmNsYXNzIEluc3RydW1lbnRzIHtcbiAgLy8gc2ltcGxlIGZhY3Rvcnkgd2l0aCBzYW5lIGRlZmF1bHRzXG4gIHN0YXRpYyBhc3luYyBxdWlja0luc3RydW1lbnRzIChvcHRzKSB7XG4gICAgb3B0cyA9IF8uY2xvbmUob3B0cyk7XG4gICAgbGV0IHhjb2RlVHJhY2VUZW1wbGF0ZVBhdGggPSBhd2FpdCB4Y29kZS5nZXRBdXRvbWF0aW9uVHJhY2VUZW1wbGF0ZVBhdGgoKTtcbiAgICBfLmRlZmF1bHRzKG9wdHMsIHtcbiAgICAgICAgICBsYXVuY2hUaW1lb3V0OiA2MDAwMCxcbiAgICAgICAgICB0ZW1wbGF0ZTogeGNvZGVUcmFjZVRlbXBsYXRlUGF0aCxcbiAgICAgICAgICB3aXRob3V0RGVsYXk6IHRydWUsXG4gICAgICAgICAgeGNvZGVWZXJzaW9uOiAnOC4xJyxcbiAgICAgICAgICB3ZWJTb2NrZXQ6IG51bGwsXG4gICAgICAgICAgZmxha2V5UmV0cmllczogMlxuICAgIH0pO1xuICAgIHJldHVybiBuZXcgSW5zdHJ1bWVudHMob3B0cyk7XG4gIH1cblxuICAvKlxuICAgKiBvcHRzOlxuICAgKiAgIC0gYXBwXG4gICAqICAgLSB0ZXJtVGltZW91dCAtIGRlZmF1bHRzIHRvIDMwMDBcbiAgICogICAtIGZsYWtleVJldHJpZXMgLSBkZWZhdWx0cyB0byAwXG4gICAqICAgLSB1ZGlkXG4gICAqICAgLSBib290c3RyYXBcbiAgICogICAtIHRlbXBsYXRlXG4gICAqICAgLSB3aXRob3V0RGVsYXlcbiAgICogICAtIHByb2Nlc3NBcmd1bWVudHNcbiAgICogICAtIHNpbXVsYXRvclNka0FuZERldmljZVxuICAgKiAgIC0gdG1wRGlyIC0gZGVmYXVsdHMgdG8gYC90bXAvYXBwaXVtLWluc3RydW1lbnRzYFxuICAgKiAgIC0gdHJhY2VEaXJcbiAgICogICAtIGxhdW5jaFRpbWVvdXQgLSBkZWZhdWx0cyB0byA5MDAwMFxuICAgKiAgIC0gd2ViU29ja2V0XG4gICAqICAgLSBpbnN0cnVtZW50c1BhdGhcbiAgICovXG4gIGNvbnN0cnVjdG9yIChvcHRzKSB7XG4gICAgb3B0cyA9IF8uY2xvbmVEZWVwKG9wdHMpO1xuICAgIF8uZGVmYXVsdHMob3B0cywge1xuICAgICAgdGVybVRpbWVvdXQ6IDMwMDAsXG4gICAgICB0bXBEaXI6ICcvdG1wL2FwcGl1bS1pbnN0cnVtZW50cycsXG4gICAgICBsYXVuY2hUaW1lb3V0OiA5MDAwMCxcbiAgICAgIGZsYWtleVJldHJpZXM6IDBcbiAgICB9KTtcblxuICAgIC8vIGNvbmZpZ1xuICAgIGZvciAobGV0IGYgb2YgWydhcHAnLCAndGVybVRpbWVvdXQnLCAnZmxha2V5UmV0cmllcycsICd1ZGlkJywgJ2Jvb3RzdHJhcCcsICd0ZW1wbGF0ZScsICd3aXRob3V0RGVsYXknLFxuICAgICAgICAgICAgICAgICAgICdwcm9jZXNzQXJndW1lbnRzJywgJ3NpbXVsYXRvclNka0FuZERldmljZScsICd0bXBEaXInLCAndHJhY2VEaXInXSkge1xuICAgICAgdGhpc1tmXSA9IG9wdHNbZl07XG4gICAgfVxuICAgIHRoaXMudHJhY2VEaXIgPSB0aGlzLnRyYWNlRGlyIHx8IHRoaXMudG1wRGlyO1xuICAgIHRoaXMubGF1bmNoVGltZW91dCA9IHBhcnNlTGF1bmNoVGltZW91dChvcHRzLmxhdW5jaFRpbWVvdXQpO1xuXG4gICAgLy8gc3RhdGVcbiAgICB0aGlzLnByb2MgPSBudWxsO1xuICAgIHRoaXMud2ViU29ja2V0ID0gb3B0cy53ZWJTb2NrZXQ7XG4gICAgdGhpcy5pbnN0cnVtZW50c1BhdGggPSBvcHRzLmluc3RydW1lbnRzUGF0aDtcbiAgICB0aGlzLmxhdW5jaFRyaWVzID0gMDtcbiAgICB0aGlzLnNvY2tldENvbm5lY3REZWxheXMgPSBbXTtcbiAgICB0aGlzLmdvdEZCU09wZW5BcHBsaWNhdGlvbkVycm9yID0gZmFsc2U7XG4gICAgdGhpcy5vblNodXRkb3duID0gbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5vblNodXRkb3duRGVmZXJyZWQgPSB7cmVzb2x2ZSwgcmVqZWN0fTtcbiAgICB9KTtcbiAgICAvLyBhdm9pZHMgVW5oYW5kbGVkRXhjZXB0aW9uXG4gICAgdGhpcy5vblNodXRkb3duLmNhdGNoKCgpID0+IHt9KS5kb25lKCk7XG4gIH1cblxuICBhc3luYyBjb25maWd1cmUgKCkge1xuICAgIGlmICghdGhpcy54Y29kZVZlcnNpb24pIHtcbiAgICAgIHRoaXMueGNvZGVWZXJzaW9uID0gYXdhaXQgeGNvZGUuZ2V0VmVyc2lvbih0cnVlKTtcbiAgICB9XG4gICAgaWYgKHRoaXMueGNvZGVWZXJzaW9uLnZlcnNpb25GbG9hdCA9PT0gNi4wICYmIHRoaXMud2l0aG91dERlbGF5KSB7XG4gICAgICBsb2cuaW5mbygnSW4geGNvZGUgNi4wLCBpbnN0cnVtZW50cy13aXRob3V0LWRlbGF5IGRvZXMgbm90IHdvcmsuICcgK1xuICAgICAgICAgICAgICAgJ0lmIHVzaW5nIEFwcGl1bSwgeW91IGNhbiBkaXNhYmxlIGluc3RydW1lbnRzLXdpdGhvdXQtZGVsYXkgJyArXG4gICAgICAgICAgICAgICAnd2l0aCB0aGUgLS1uYXRpdmUtaW5zdHJ1bWVudHMtbGliIHNlcnZlciBmbGFnJyk7XG4gICAgfVxuICAgIGlmICh0aGlzLnhjb2RlVmVyc2lvbi52ZXJzaW9uU3RyaW5nID09PSAnNS4wLjEnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1hjb2RlIDUuMC4xIHNoaXBzIHdpdGggYSBicm9rZW4gdmVyc2lvbiBvZiAnICtcbiAgICAgICAgICAgICAgICAgICAgICAnSW5zdHJ1bWVudHMuIHBsZWFzZSB1cGdyYWRlIHRvIDUuMC4yJyk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnRlbXBsYXRlKSB7XG4gICAgICB0aGlzLnRlbXBsYXRlID0gYXdhaXQgeGNvZGUuZ2V0QXV0b21hdGlvblRyYWNlVGVtcGxhdGVQYXRoKCk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmluc3RydW1lbnRzUGF0aCkge1xuICAgICAgdGhpcy5pbnN0cnVtZW50c1BhdGggPSBhd2FpdCBnZXRJbnN0cnVtZW50c1BhdGgoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBsYXVuY2hPbmNlICgpIHtcbiAgICBsb2cuaW5mbygnTGF1bmNoaW5nIGluc3RydW1lbnRzJyk7XG4gICAgLy8gcHJlcGFyZSB0ZW1wIGRpclxuICAgIGF3YWl0IGZzLnJpbXJhZih0aGlzLnRtcERpcik7XG4gICAgYXdhaXQgbWtkaXJwKHRoaXMudG1wRGlyKTtcbiAgICBhd2FpdCBta2RpcnAodGhpcy50cmFjZURpcik7XG5cbiAgICB0aGlzLmV4aXRMaXN0ZW5lciA9IG51bGw7XG4gICAgdGhpcy5wcm9jID0gYXdhaXQgdGhpcy5zcGF3bkluc3RydW1lbnRzKCk7XG4gICAgdGhpcy5wcm9jLm9uKCdleGl0JywgKGNvZGUpID0+IHtcbiAgICAgIGxvZy5kZWJ1ZyhgSW5zdHJ1bWVudHMgZXhpdGVkIHdpdGggY29kZSAke2NvZGV9YCk7XG4gICAgfSk7XG5cbiAgICBsZXQgbGF1bmNoUmVzdWx0UHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMubGF1bmNoUmVzdWx0RGVmZXJyZWQgPSB7cmVzb2x2ZSwgcmVqZWN0fTtcbiAgICB9KTtcblxuICAgIC8vIFRoZXJlIHdhcyBhIHNwZWNpYWwgY2FzZSBmb3IgaWdub3JlU3RhcnR1cEV4aXRcbiAgICAvLyBidXQgaXQgaXMgbm90IG5lZWRlZCBhbnltb3JlLCB5b3UgbWF5IGp1c3QgbGlzdGVuIGZvciBleGl0LlxuICAgIHRoaXMuc2V0RXhpdExpc3RlbmVyKCgpID0+IHtcbiAgICAgIHRoaXMucHJvYyA9IG51bGw7XG4gICAgICB0aGlzLmxhdW5jaFJlc3VsdERlZmVycmVkLnJlamVjdChuZXcgRXJyb3IoRVJSX0NSQVNIRURfT05fU1RBUlRVUCkpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5wcm9jLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgIGxvZy5kZWJ1ZyhgRXJyb3Igd2l0aCBpbnN0cnVtZW50cyBwcm9jOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgaWYgKGVyci5tZXNzYWdlLmluZGV4T2YoJ0VOT0VOVCcpICE9PSAtMSkge1xuICAgICAgICB0aGlzLnByb2MgPSBudWxsOyAvLyBvdGhlcndpc2Ugd2UnbGwgdHJ5IHRvIHNlbmQgc2lna2lsbFxuICAgICAgICBsb2cuZXJyb3IoYFVuYWJsZSB0byBzcGF3biBpbnN0cnVtZW50czogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgdGhpcy5sYXVuY2hSZXN1bHREZWZlcnJlZC5yZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMucHJvYy5zdGRvdXQuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgICB0aGlzLnByb2Muc3Rkb3V0LnBpcGUob3V0cHV0U3RyZWFtKCkpLnBpcGUoZHVtcFN0cmVhbSgpKTtcblxuICAgIHRoaXMucHJvYy5zdGRlcnIuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgICBsZXQgYWN0T25TdGRlcnIgPSAob3V0cHV0KSA9PiB7XG4gICAgICBpZiAodGhpcy5sYXVuY2hUaW1lb3V0LmFmdGVyU2ltTGF1bmNoICYmIG91dHB1dCAmJiBvdXRwdXQubWF0Y2goL0NMVGlsZXNNYW5hZ2VyQ2xpZW50OiBpbml0aWFsaXplLykpIHtcbiAgICAgICAgdGhpcy5hZGRTb2NrZXRDb25uZWN0VGltZXIodGhpcy5sYXVuY2hUaW1lb3V0LmFmdGVyU2ltTGF1bmNoLCAnYWZ0ZXJMYXVuY2gnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgYXdhaXQga2lsbEFsbEluc3RydW1lbnRzKCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBsZXQgZmJzRXJyU3RyID0gJyhGQlNPcGVuQXBwbGljYXRpb25FcnJvckRvbWFpbiBlcnJvciA4LiknO1xuICAgICAgaWYgKG91dHB1dC5pbmRleE9mKGZic0VyclN0cikgIT09IC0xKSB7XG4gICAgICAgIHRoaXMuZ290RkJTT3BlbkFwcGxpY2F0aW9uRXJyb3IgPSB0cnVlO1xuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5wcm9jLnN0ZGVyci5waXBlKHRocm91Z2goZnVuY3Rpb24gKG91dHB1dCkge1xuICAgICAgYWN0T25TdGRlcnIob3V0cHV0KTtcbiAgICAgIHRoaXMucXVldWUob3V0cHV0KTtcbiAgICB9KSkucGlwZShlcnJvclN0cmVhbSgpKVxuICAgIC5waXBlKHdlYlNvY2tldEFsZXJ0U3RyZWFtKHRoaXMud2ViU29ja2V0KSlcbiAgICAucGlwZShkdW1wU3RyZWFtKCkpO1xuXG4gICAgLy8gc3RhcnQgd2FpdGluZyBmb3IgaW5zdHJ1bWVudHMgdG8gbGF1bmNoIHN1Y2Nlc3NmdWxseVxuICAgIHRoaXMuYWRkU29ja2V0Q29ubmVjdFRpbWVyKHRoaXMubGF1bmNoVGltZW91dC5nbG9iYWwsICdnbG9iYWwnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBraWxsQWxsSW5zdHJ1bWVudHMoKTtcbiAgICB9KTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBsYXVuY2hSZXN1bHRQcm9taXNlO1xuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLmNsZWFyU29ja2V0Q29ubmVjdFRpbWVycygpO1xuICAgIH1cbiAgICB0aGlzLnNldEV4aXRMaXN0ZW5lcigoY29kZSkgPT4ge1xuICAgICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICAgIHRoaXMub25TaHV0ZG93bkRlZmVycmVkLnJlamVjdChuZXcgRXJyb3IoYEFibm9ybWFsIGV4aXQgd2l0aCBjb2RlOiAke2NvZGV9YCkpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgbGF1bmNoICgpIHtcbiAgICBhd2FpdCB0aGlzLmNvbmZpZ3VyZSgpO1xuICAgIGxldCBsYXVuY2hUcmllcyA9IDA7XG4gICAgZG8ge1xuICAgICAgaWYgKGxhdW5jaFRyaWVzID4gMCkge1xuICAgICAgICBsb2cuZGVidWcoYEF0dGVtcHRpbmcgdG8gcmV0cnkgbGF1bmNoaW5nIGluc3RydW1lbnRzLCB0aGlzIGlzIGAgK1xuICAgICAgICAgICAgICAgICAgYHJldHJ5ICMke2xhdW5jaFRyaWVzfWApO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgbGF1bmNoVHJpZXMrKztcbiAgICAgICAgYXdhaXQgdGhpcy5sYXVuY2hPbmNlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhlcnIubWVzc2FnZSk7XG4gICAgICAgIGxldCBlcnJJc0NhdGNoYWJsZSA9IGVyci5tZXNzYWdlID09PSBFUlJfTkVWRVJfQ0hFQ0tFRF9JTiB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnIubWVzc2FnZSA9PT0gRVJSX0NSQVNIRURfT05fU1RBUlRVUDtcbiAgICAgICAgaWYgKGVycklzQ2F0Y2hhYmxlKSB7XG4gICAgICAgICAgaWYgKGxhdW5jaFRyaWVzIDwgKHRoaXMuZmxha2V5UmV0cmllcyArIDEpKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5nb3RGQlNPcGVuQXBwbGljYXRpb25FcnJvcikge1xuICAgICAgICAgICAgICBsb2cuZGVidWcoJ0dvdCB0aGUgRkJTT3BlbkFwcGxpY2F0aW9uRXJyb3IsIG5vdCBraWxsaW5nIHRoZSAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICdzaW0gYnV0IGxlYXZpbmcgaXQgb3BlbiBzbyB0aGUgYXBwIHdpbGwgbGF1bmNoJyk7XG4gICAgICAgICAgICAgIHRoaXMuZ290RkJTT3BlbkFwcGxpY2F0aW9uRXJyb3IgPSBmYWxzZTsgLy8gY2xlYXIgb3V0IGZvciBuZXh0IGxhdW5jaFxuICAgICAgICAgICAgICBhd2FpdCBCLmRlbGF5KDEwMDApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgYXdhaXQga2lsbEFsbFNpbXVsYXRvcnMoKTtcbiAgICAgICAgICAgICAgYXdhaXQgQi5kZWxheSg1MDAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coJ1dlIGV4Y2VlZGVkIHRoZSBudW1iZXIgb2YgcmV0cmllcyBhbGxvd2VkIGZvciAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdpbnN0cnVtZW50cyB0byBzdWNjZXNzZnVsbHkgc3RhcnQ7IGZhaWxpbmcgbGF1bmNoJyk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gd2hpbGUgKHRydWUpO1xuICB9XG5cbiAgcmVnaXN0ZXJMYXVuY2ggKCkge1xuICAgIHRoaXMubGF1bmNoUmVzdWx0RGVmZXJyZWQucmVzb2x2ZSgpO1xuICB9XG5cbiAgYXN5bmMgc3Bhd25JbnN0cnVtZW50cyAoKSB7XG4gICAgbGV0IHRyYWNlRGlyO1xuICAgIGZvciAobGV0IGkgPSAwOyA7IGkrKykge1xuICAgICAgLy8gbG9vcCB3aGlsZSB0aGVyZSBhcmUgdHJhY2VkaXJzIHRvIGRlbGV0ZVxuICAgICAgdHJhY2VEaXIgPSBwYXRoLnJlc29sdmUodGhpcy50cmFjZURpciwgYGluc3RydW1lbnRzY2xpJHtpfS50cmFjZWApO1xuICAgICAgaWYgKCFhd2FpdCBmcy5leGlzdHModHJhY2VEaXIpKSBicmVhaztcbiAgICB9XG4gICAgbGV0IGFyZ3MgPSBbJy10JywgdGhpcy50ZW1wbGF0ZSwgJy1EJywgdHJhY2VEaXJdO1xuICAgIGlmICh0aGlzLnVkaWQpIHtcbiAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbJy13JywgdGhpcy51ZGlkXSk7XG4gICAgICBsb2cuZGVidWcoYEF0dGVtcHRpbmcgdG8gcnVuIGFwcCBvbiByZWFsIGRldmljZSB3aXRoIFVESUQgJHt0aGlzLnVkaWR9YCk7XG4gICAgfVxuICAgIGlmICghdGhpcy51ZGlkICYmIHRoaXMuc2ltdWxhdG9yU2RrQW5kRGV2aWNlKSB7XG4gICAgICBhcmdzID0gYXJncy5jb25jYXQoWyctdycsIHRoaXMuc2ltdWxhdG9yU2RrQW5kRGV2aWNlXSk7XG4gICAgICBsb2cuZGVidWcoYEF0dGVtcHRpbmcgdG8gcnVuIGFwcCBvbiAke3RoaXMuc2ltdWxhdG9yU2RrQW5kRGV2aWNlfWApO1xuICAgIH1cbiAgICBhcmdzID0gYXJncy5jb25jYXQoW3RoaXMuYXBwXSk7XG4gICAgaWYgKHRoaXMucHJvY2Vzc0FyZ3VtZW50cykge1xuICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KHRoaXMucHJvY2Vzc0FyZ3VtZW50cyk7XG4gICAgICBsb2cuZGVidWcoYEF0dGVtcHRpbmcgdG8gcnVuIGFwcCB3aXRoIHByb2Nlc3MgYXJndW1lbnRzOiAke0pTT04uc3RyaW5naWZ5KHRoaXMucHJvY2Vzc0FyZ3VtZW50cyl9YCk7XG4gICAgfVxuICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbJy1lJywgJ1VJQVNDUklQVCcsIHRoaXMuYm9vdHN0cmFwXSk7XG4gICAgYXJncyA9IGFyZ3MuY29uY2F0KFsnLWUnLCAnVUlBUkVTVUxUU1BBVEgnLCB0aGlzLnRtcERpcl0pO1xuICAgIGxldCBlbnYgPSBfLmNsb25lKHByb2Nlc3MuZW52KTtcbiAgICBsZXQgaXdkUGF0aCA9IGF3YWl0IGdldEl3ZFBhdGgodGhpcy54Y29kZVZlcnNpb24ubWFqb3IpO1xuICAgIGVudi5DQV9ERUJVR19UUkFOU0FDVElPTlMgPSAxO1xuICAgIGlmICh0aGlzLndpdGhvdXREZWxheSAmJiAhdGhpcy51ZGlkKSB7XG4gICAgICBlbnYuRFlMRF9JTlNFUlRfTElCUkFSSUVTID0gcGF0aC5yZXNvbHZlKGl3ZFBhdGgsICdJbnN0cnVtZW50c1NoaW0uZHlsaWInKTtcbiAgICAgIGVudi5MSUJfUEFUSCA9IGl3ZFBhdGg7XG4gICAgfVxuICAgIGxldCBpbnN0cnVtZW50c0V4ZWNBcmdzID0gW3RoaXMuaW5zdHJ1bWVudHNQYXRoLCAuLi5fLmNsb25lKGFyZ3MpXTtcbiAgICBpbnN0cnVtZW50c0V4ZWNBcmdzID0gXy5tYXAoaW5zdHJ1bWVudHNFeGVjQXJncywgZnVuY3Rpb24gKGFyZykge1xuICAgICAgaWYgKGFyZyA9PT0gbnVsbCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0EgbnVsbCB2YWx1ZSB3YXMgcGFzc2VkIGFzIGFuIGFyZyB0byBleGVjdXRlICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ2luc3RydW1lbnRzIG9uIHRoZSBjb21tYW5kIGxpbmUuIEEgbGV0aWFibGUgaXMgJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAncHJvYmFibHkgbm90IGdldHRpbmcgc2V0LiBBcnJheSBvZiBjb21tYW5kIGFyZ3M6ICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoaW5zdHJ1bWVudHNFeGVjQXJncykpO1xuICAgICAgfVxuICAgICAgaWYgKF8uaXNTdHJpbmcoYXJnKSAmJiBhcmcuaW5kZXhPZignICcpICE9PSAtMSkge1xuICAgICAgICByZXR1cm4gYFwiJHthcmd9XCJgO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFyZztcbiAgICB9KTtcbiAgICBsb2cuZGVidWcoYFNwYXduaW5nIGluc3RydW1lbnRzIHdpdGggY29tbWFuZDogJHtpbnN0cnVtZW50c0V4ZWNBcmdzLmpvaW4oJyAnKX1gKTtcbiAgICBsb2cuZGVidWcoJ0FuZCBleHRyYSB3aXRob3V0LWRlbGF5IGVudjogJyArIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIERZTERfSU5TRVJUX0xJQlJBUklFUzogZW52LkRZTERfSU5TRVJUX0xJQlJBUklFUyxcbiAgICAgIExJQl9QQVRIOiBlbnYuTElCX1BBVEhcbiAgICB9KSk7XG4gICAgbG9nLmRlYnVnKGBBbmQgbGF1bmNoIHRpbWVvdXRzIChpbiBtcyk6ICR7SlNPTi5zdHJpbmdpZnkodGhpcy5sYXVuY2hUaW1lb3V0KX1gKTtcbiAgICByZXR1cm4gYXdhaXQgc3Bhd24odGhpcy5pbnN0cnVtZW50c1BhdGgsIGFyZ3MsIHtlbnY6IGVudn0pO1xuICB9XG5cbiAgYWRkU29ja2V0Q29ubmVjdFRpbWVyIChkZWxheSwgdHlwZSwgZG9BY3Rpb24pIHtcbiAgICBsZXQgc29ja2V0Q29ubmVjdERlbGF5ID0gY2FuY2VsbGFibGVEZWxheShkZWxheSk7XG4gICAgc29ja2V0Q29ubmVjdERlbGF5LnRoZW4oKCkgPT4ge1xuICAgICAgbG9nLndhcm4oYEluc3RydW1lbnRzIHNvY2tldCBjbGllbnQgbmV2ZXIgY2hlY2tlZCBpbjsgdGltaW5nIG91dCAoJHt0eXBlfSlgKTtcbiAgICAgIHRoaXMuc2V0RXhpdExpc3RlbmVyKCgpID0+IHtcbiAgICAgICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICAgICAgdGhpcy5sYXVuY2hSZXN1bHREZWZlcnJlZC5yZWplY3QobmV3IEVycm9yKEVSUl9ORVZFUl9DSEVDS0VEX0lOKSk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBkb0FjdGlvbigpO1xuICAgIH0pLmNhdGNoKEIuQ2FuY2VsbGF0aW9uRXJyb3IsICgpID0+IHt9KS5kb25lKCk7XG4gICAgdGhpcy5zb2NrZXRDb25uZWN0RGVsYXlzLnB1c2goc29ja2V0Q29ubmVjdERlbGF5KTtcbiAgfVxuXG4gIGNsZWFyU29ja2V0Q29ubmVjdFRpbWVycyAoKSB7XG4gICAgZm9yIChsZXQgZGVsYXkgb2YgdGhpcy5zb2NrZXRDb25uZWN0RGVsYXlzKSB7XG4gICAgICBkZWxheS5jYW5jZWwoKTtcbiAgICB9XG4gICAgdGhpcy5zb2NrZXRDb25uZWN0RGVsYXlzID0gW107XG4gIH1cblxuICBzZXRFeGl0TGlzdGVuZXIgKGV4aXRMaXN0ZW5lcikge1xuICAgIGlmICghdGhpcy5wcm9jKSByZXR1cm47XG4gICAgaWYgKHRoaXMuZXhpdExpc3RlbmVyKSB7XG4gICAgICB0aGlzLnByb2MucmVtb3ZlTGlzdGVuZXIoJ2V4aXQnLCB0aGlzLmV4aXRMaXN0ZW5lcik7XG4gICAgfVxuICAgIHRoaXMuZXhpdExpc3RlbmVyID0gZXhpdExpc3RlbmVyO1xuICAgIHRoaXMucHJvYy5vbignZXhpdCcsIGV4aXRMaXN0ZW5lcik7XG4gIH1cblxuICAvKiBQUk9DRVNTIE1BTkFHRU1FTlQgKi9cbiAgYXN5bmMgc2h1dGRvd24gKCkge1xuICAgIGlmICh0aGlzLnByb2MpIHtcbiAgICAgIGxvZy5kZWJ1ZygnU3RhcnRpbmcgc2h1dGRvd24uJyk7XG4gICAgICBsZXQgd2FzVGVybWluYXRlZCA9IGZhbHNlO1xuICAgICAgLy8gbW9uaXRvcmluZyBwcm9jZXNzIHRlcm1pbmF0aW9uXG4gICAgICBsZXQgdGVybURlbGF5ID0gY2FuY2VsbGFibGVEZWxheSh0aGlzLnRlcm1UaW1lb3V0KTtcbiAgICAgIGxldCB0ZXJtUHJvbWlzZSA9IHRlcm1EZWxheS5jYXRjaChCLkNhbmNlbGxhdGlvbkVycm9yLCAoKSA9PiB7fSk7XG4gICAgICB0aGlzLnNldEV4aXRMaXN0ZW5lcigoKSA9PiB7XG4gICAgICAgIHRoaXMucHJvYyA9IG51bGw7XG4gICAgICAgIHdhc1Rlcm1pbmF0ZWQgPSB0cnVlO1xuICAgICAgICB0ZXJtRGVsYXkuY2FuY2VsKCk7XG4gICAgICAgIHRoaXMub25TaHV0ZG93bkRlZmVycmVkLnJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgICAgbG9nLmRlYnVnKCdTZW5kaW5nIHNpZ3Rlcm0gdG8gaW5zdHJ1bWVudHMnKTtcbiAgICAgIHRoaXMucHJvYy5raWxsKCdTSUdURVJNJyk7XG4gICAgICBhd2FpdCB0ZXJtUHJvbWlzZTtcbiAgICAgIGlmICghd2FzVGVybWluYXRlZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEluc3RydW1lbnRzIGRpZCBub3QgdGVybWluYXRlIGFmdGVyICR7dGhpcy50ZXJtVGltZW91dCAvIDEwMDB9IHNlY29uZHMhYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEluc3RydW1lbnRzO1xuIl19