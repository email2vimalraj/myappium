'use strict';

var _Promise = require('babel-runtime/core-js/promise')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this = this;

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _ = require('..');

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _helpers = require('./helpers');

require('source-map-support').install();

var should = _chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('SubProcess', function () {
  it('should throw an error if initialized without a command', function () {
    should['throw'](function () {
      new _.SubProcess();
    });
  });
  it('should throw an error if initialized with a bad command', function () {
    should['throw'](function () {
      new _.SubProcess({ lol: true });
    });
    should['throw'](function () {
      new _.SubProcess(1);
    });
  });
  it('should throw an error if initialized with bad args', function () {
    should['throw'](function () {
      new _.SubProcess('ls', 'foo');
    });
    should['throw'](function () {
      new _.SubProcess('ls', 1);
    });
    should['throw'](function () {
      new _.SubProcess('ls', {});
    });
  });
  it('should default args list to []', function () {
    var x = new _.SubProcess('ls');
    x.args.should.eql([]);
  });
  it('should default opts dict to {}', function () {
    var x = new _.SubProcess('ls');
    x.opts.should.eql({});
  });
  it('should pass opts to spawn', function callee$1$0() {
    var cwd, subproc, lines;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cwd = _path2['default'].resolve(_helpers.getFixture('.'));
          subproc = new _.SubProcess('ls', [], { cwd: cwd });
          lines = [];

          subproc.on('lines-stdout', function (newLines) {
            lines = lines.concat(newLines);
          });
          context$2$0.next = 6;
          return subproc.start(0);

        case 6:
          context$2$0.next = 8;
          return _bluebird2['default'].delay(50);

        case 8:
          lines.should.include('bad_exit.sh');
          lines.should.contain('bigbuffer.js');
          lines.should.contain('echo.sh');

        case 11:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  describe('#start', function () {
    it('should throw an error if command fails on startup', function callee$2$0() {
      var s;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            s = new _.SubProcess('blargimarg');
            context$3$0.next = 3;
            return s.start().should.eventually.be.rejectedWith(/ENOENT/);

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should have a default startDetector of waiting for output', function callee$2$1() {
      var hasData, s;
      return _regeneratorRuntime.async(function callee$2$1$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            hasData = false;
            s = new _.SubProcess('ls');

            s.on('output', function (stdout) {
              if (stdout) {
                hasData = true;
              }
            });
            context$3$0.next = 5;
            return s.start();

          case 5:
            hasData.should.be['true'];

          case 6:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should interpret a numeric startDetector as a start timeout', function callee$2$2() {
      var hasData, s;
      return _regeneratorRuntime.async(function callee$2$2$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            hasData = false;
            s = new _.SubProcess(_helpers.getFixture('sleepyproc.sh'), ['ls']);

            s.on('output', function (stdout) {
              if (stdout) {
                hasData = true;
              }
            });
            context$3$0.next = 5;
            return s.start(0);

          case 5:
            hasData.should.be['false'];
            context$3$0.next = 8;
            return _bluebird2['default'].delay(1200);

          case 8:
            hasData.should.be['true'];

          case 9:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should fail even with a start timeout of 0 when command is bad', function callee$2$3() {
      var s;
      return _regeneratorRuntime.async(function callee$2$3$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            s = new _.SubProcess('blargimarg');
            context$3$0.next = 3;
            return s.start(0).should.eventually.be.rejectedWith(/ENOENT/);

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should be able to provide a custom startDetector function', function callee$2$4() {
      var sd, hasData, s;
      return _regeneratorRuntime.async(function callee$2$4$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            sd = function sd(stdout) {
              return stdout;
            };

            hasData = false;
            s = new _.SubProcess('ls');

            s.on('output', function (stdout) {
              if (stdout) {
                hasData = true;
              }
            });
            context$3$0.next = 6;
            return s.start(sd);

          case 6:
            hasData.should.be['true'];

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should pass on custom errors from startDetector', function callee$2$5() {
      var sd, s;
      return _regeneratorRuntime.async(function callee$2$5$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            sd = function sd() {
              throw new Error('foo');
            };

            s = new _.SubProcess('ls');
            context$3$0.next = 4;
            return s.start(sd).should.eventually.be.rejectedWith(/foo/);

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should time out starts that take longer than specified ms', function callee$2$6() {
      var sd, s, start;
      return _regeneratorRuntime.async(function callee$2$6$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            sd = function sd(stdout) {
              return stdout.indexOf('nothere') !== -1;
            };

            s = new _.SubProcess('ls');
            start = Date.now();
            context$3$0.next = 5;
            return s.start(sd, 500).should.eventually.be.rejectedWith(/did not start.+time/i);

          case 5:
            (Date.now() - start).should.be.below(600);

          case 6:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });

  describe('listening for data', function () {
    var subproc = undefined;
    it('should get output as params', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        var _this2 = this;

        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return new _Promise(function callee$3$0(resolve) {
              return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                while (1) switch (context$4$0.prev = context$4$0.next) {
                  case 0:
                    subproc = new _.SubProcess(_helpers.getFixture('sleepyproc.sh'), ['ls', _path2['default'].resolve(__dirname)]);
                    subproc.on('output', function (stdout) {
                      if (stdout && stdout.indexOf('subproc-specs') !== -1) {
                        resolve();
                      }
                    });
                    context$4$0.next = 4;
                    return subproc.start();

                  case 4:
                  case 'end':
                    return context$4$0.stop();
                }
              }, null, _this2);
            });

          case 2:
            context$3$0.next = 4;
            return subproc.stop();

          case 4:
            context$3$0.next = 6;
            return new _Promise(function callee$3$1(resolve) {
              return _regeneratorRuntime.async(function callee$3$1$(context$4$0) {
                while (1) switch (context$4$0.prev = context$4$0.next) {
                  case 0:
                    subproc = new _.SubProcess(_helpers.getFixture('echo.sh'), ['foo', 'bar']);
                    subproc.on('output', function (stdout, stderr) {
                      if (stderr && stderr.indexOf('bar') !== -1) {
                        resolve();
                      }
                    });
                    context$4$0.next = 4;
                    return subproc.start();

                  case 4:
                  case 'end':
                    return context$4$0.stop();
                }
              }, null, _this2);
            });

          case 6:
            context$3$0.next = 8;
            return subproc.stop();

          case 8:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should get output by lines', function callee$2$1() {
      var lines;
      return _regeneratorRuntime.async(function callee$2$1$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            subproc = new _.SubProcess('ls', [_path2['default'].resolve(__dirname)]);
            lines = [];

            subproc.on('lines-stdout', function (newLines) {
              lines = lines.concat(newLines);
            });
            context$3$0.next = 5;
            return subproc.start(0);

          case 5:
            context$3$0.next = 7;
            return _bluebird2['default'].delay(50);

          case 7:
            lines.should.eql(['exec-specs.js', 'fixtures', 'helpers.js', 'subproc-specs.js']);

          case 8:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });

  describe('#stop', function () {
    it('should send the right signal to stop a proc', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        var _this3 = this;

        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            return context$3$0.abrupt('return', new _Promise(function callee$3$0(resolve, reject) {
              var subproc;
              return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                while (1) switch (context$4$0.prev = context$4$0.next) {
                  case 0:
                    subproc = new _.SubProcess('tail', ['-f', _path2['default'].resolve(__filename)]);
                    context$4$0.next = 3;
                    return subproc.start();

                  case 3:
                    subproc.on('exit', function (code, signal) {
                      try {
                        signal.should.equal('SIGHUP');
                        resolve();
                      } catch (e) {
                        reject(e);
                      }
                    });
                    context$4$0.next = 6;
                    return subproc.stop('SIGHUP');

                  case 6:
                  case 'end':
                    return context$4$0.stop();
                }
              }, null, _this3);
            }));

          case 1:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should time out if stop doesnt complete fast enough', function callee$2$1() {
      var subproc;
      return _regeneratorRuntime.async(function callee$2$1$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            subproc = new _.SubProcess(_helpers.getFixture('traphup.sh'), ['tail', '-f', _path2['default'].resolve(__filename)]);
            context$3$0.next = 3;
            return subproc.start();

          case 3:
            context$3$0.next = 5;
            return subproc.stop('SIGHUP', 10).should.eventually.be.rejectedWith(/Process didn't end/);

          case 5:
            context$3$0.prev = 5;
            context$3$0.next = 8;
            return _.exec('kill', ['-9', subproc.proc.pid + 1]);

          case 8:
            context$3$0.next = 12;
            break;

          case 10:
            context$3$0.prev = 10;
            context$3$0.t2 = context$3$0['catch'](5);

          case 12:
            context$3$0.prev = 12;
            context$3$0.next = 15;
            return _.exec('kill', ['-9', subproc.proc.pid]);

          case 15:
            context$3$0.next = 19;
            break;

          case 17:
            context$3$0.prev = 17;
            context$3$0.t3 = context$3$0['catch'](12);

          case 19:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this, [[5, 10], [12, 17]]);
    });

    it('should error if there is no process to stop', function callee$2$2() {
      var subproc;
      return _regeneratorRuntime.async(function callee$2$2$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            subproc = new _.SubProcess('ls');
            context$3$0.next = 3;
            return subproc.stop().should.eventually.be.rejectedWith(/Can't stop/);

          case 3:
            context$3$0.next = 5;
            return subproc.start();

          case 5:
            context$3$0.next = 7;
            return _bluebird2['default'].delay(10);

          case 7:
            context$3$0.next = 9;
            return subproc.stop().should.eventually.be.rejectedWith(/Can't stop/);

          case 9:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });

  describe('#join', function () {
    it('should fail if the #start has not yet been called', function callee$2$0() {
      var proc;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            proc = new _.SubProcess(_helpers.getFixture('sleepyproc.sh'), ['ls']);
            context$3$0.next = 3;
            return proc.join().should.eventually.be.rejectedWith(/Can't join/);

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should wait until the process has been finished', function callee$2$1() {
      var proc, now, diff;
      return _regeneratorRuntime.async(function callee$2$1$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            proc = new _.SubProcess(_helpers.getFixture('sleepyproc.sh'), ['ls']);
            now = Date.now();
            context$3$0.next = 4;
            return proc.start(0);

          case 4:
            context$3$0.next = 6;
            return proc.join();

          case 6:
            diff = Date.now() - now;

            diff.should.be.above(1000);

          case 8:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should throw if process ends with a invalid exitcode', function callee$2$2() {
      var proc;
      return _regeneratorRuntime.async(function callee$2$2$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            proc = new _.SubProcess(_helpers.getFixture('bad_exit.sh'));
            context$3$0.next = 3;
            return proc.start(0);

          case 3:
            context$3$0.next = 5;
            return proc.join().should.eventually.be.rejectedWith(/Process ended with exitcode/);

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should NOT throw if process ends with a custom allowed exitcode', function callee$2$3() {
      var proc;
      return _regeneratorRuntime.async(function callee$2$3$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            proc = new _.SubProcess(_helpers.getFixture('bad_exit.sh'));
            context$3$0.next = 3;
            return proc.start(0);

          case 3:
            context$3$0.next = 5;
            return proc.join([1]).should.eventually.be.become(1);

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });
});

// need to kill the process
// 1 for the trap, 1 for the tail
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3Qvc3VicHJvYy1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O3dCQUVjLFVBQVU7Ozs7b0JBQ1AsTUFBTTs7OztnQkFDVSxJQUFJOztvQkFDcEIsTUFBTTs7Ozs4QkFDSSxrQkFBa0I7Ozs7dUJBQ2xCLFdBQVc7O0FBUHRDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDOztBQVV4QyxJQUFNLE1BQU0sR0FBRyxrQkFBSyxNQUFNLEVBQUUsQ0FBQztBQUM3QixrQkFBSyxHQUFHLDZCQUFnQixDQUFDOztBQUV6QixRQUFRLENBQUMsWUFBWSxFQUFFLFlBQU07QUFDM0IsSUFBRSxDQUFDLHdEQUF3RCxFQUFFLFlBQU07QUFDakUsVUFBTSxTQUFNLENBQUMsWUFBTTtBQUNqQixZQVpTLFVBQVUsRUFZSCxDQUFDO0tBQ2xCLENBQUMsQ0FBQztHQUNKLENBQUMsQ0FBQztBQUNILElBQUUsQ0FBQyx5REFBeUQsRUFBRSxZQUFNO0FBQ2xFLFVBQU0sU0FBTSxDQUFDLFlBQU07QUFDakIsWUFqQlMsVUFBVSxDQWlCSixFQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO0tBQzdCLENBQUMsQ0FBQztBQUNILFVBQU0sU0FBTSxDQUFDLFlBQU07QUFDakIsWUFwQlMsVUFBVSxDQW9CSixDQUFDLENBQUMsQ0FBQztLQUNuQixDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7QUFDSCxJQUFFLENBQUMsb0RBQW9ELEVBQUUsWUFBTTtBQUM3RCxVQUFNLFNBQU0sQ0FBQyxZQUFNO0FBQ2pCLFlBekJTLFVBQVUsQ0F5QkosSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0tBQzdCLENBQUMsQ0FBQztBQUNILFVBQU0sU0FBTSxDQUFDLFlBQU07QUFDakIsWUE1QlMsVUFBVSxDQTRCSixJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7S0FDekIsQ0FBQyxDQUFDO0FBQ0gsVUFBTSxTQUFNLENBQUMsWUFBTTtBQUNq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QkFDaEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Ozs7bUJBQ2IsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQzs7Ozs7OztLQUNwRCxDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMiLCJmaWxlIjoidGVzdC9zdWJwcm9jLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsicmVxdWlyZSgnc291cmNlLW1hcC1zdXBwb3J0JykuaW5zdGFsbCgpO1xuXG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGV4ZWMsIFN1YlByb2Nlc3MgfSBmcm9tICcuLic7XG5pbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCB7IGdldEZpeHR1cmUgfSBmcm9tICcuL2hlbHBlcnMnO1xuXG5cbmNvbnN0IHNob3VsZCA9IGNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmRlc2NyaWJlKCdTdWJQcm9jZXNzJywgKCkgPT4ge1xuICBpdCgnc2hvdWxkIHRocm93IGFuIGVycm9yIGlmIGluaXRpYWxpemVkIHdpdGhvdXQgYSBjb21tYW5kJywgKCkgPT4ge1xuICAgIHNob3VsZC50aHJvdygoKSA9PiB7XG4gICAgICBuZXcgU3ViUHJvY2VzcygpO1xuICAgIH0pO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCB0aHJvdyBhbiBlcnJvciBpZiBpbml0aWFsaXplZCB3aXRoIGEgYmFkIGNvbW1hbmQnLCAoKSA9PiB7XG4gICAgc2hvdWxkLnRocm93KCgpID0+IHtcbiAgICAgIG5ldyBTdWJQcm9jZXNzKHtsb2w6IHRydWV9KTtcbiAgICB9KTtcbiAgICBzaG91bGQudGhyb3coKCkgPT4ge1xuICAgICAgbmV3IFN1YlByb2Nlc3MoMSk7XG4gICAgfSk7XG4gIH0pO1xuICBpdCgnc2hvdWxkIHRocm93IGFuIGVycm9yIGlmIGluaXRpYWxpemVkIHdpdGggYmFkIGFyZ3MnLCAoKSA9PiB7XG4gICAgc2hvdWxkLnRocm93KCgpID0+IHtcbiAgICAgIG5ldyBTdWJQcm9jZXNzKCdscycsICdmb28nKTtcbiAgICB9KTtcbiAgICBzaG91bGQudGhyb3coKCkgPT4ge1xuICAgICAgbmV3IFN1YlByb2Nlc3MoJ2xzJywgMSk7XG4gICAgfSk7XG4gICAgc2hvdWxkLnRocm93KCgpID0+IHtcbiAgICAgIG5ldyBTdWJQcm9jZXNzKCdscycsIHt9KTtcbiAgICB9KTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgZGVmYXVsdCBhcmdzIGxpc3QgdG8gW10nLCAoKSA9PiB7XG4gICAgbGV0IHggPSBuZXcgU3ViUHJvY2VzcygnbHMnKTtcbiAgICB4LmFyZ3Muc2hvdWxkLmVxbChbXSk7XG4gIH0pO1xuICBpdCgnc2hvdWxkIGRlZmF1bHQgb3B0cyBkaWN0IHRvIHt9JywgKCkgPT4ge1xuICAgIGxldCB4ID0gbmV3IFN1YlByb2Nlc3MoJ2xzJyk7XG4gICAgeC5vcHRzLnNob3VsZC5lcWwoe30pO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCBwYXNzIG9wdHMgdG8gc3Bhd24nLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgY3dkID0gcGF0aC5yZXNvbHZlKGdldEZpeHR1cmUoJy4nKSk7XG4gICAgY29uc3Qgc3VicHJvYyA9IG5ldyBTdWJQcm9jZXNzKCdscycsIFtdLCB7Y3dkfSk7XG4gICAgbGV0IGxpbmVzID0gW107XG4gICAgc3VicHJvYy5vbignbGluZXMtc3Rkb3V0JywgKG5ld0xpbmVzKSA9PiB7XG4gICAgICBsaW5lcyA9IGxpbmVzLmNvbmNhdChuZXdMaW5lcyk7XG4gICAgfSk7XG4gICAgYXdhaXQgc3VicHJvYy5zdGFydCgwKTtcbiAgICBhd2FpdCBCLmRlbGF5KDUwKTtcbiAgICBsaW5lcy5zaG91bGQuaW5jbHVkZSgnYmFkX2V4aXQuc2gnKTtcbiAgICBsaW5lcy5zaG91bGQuY29udGFpbignYmlnYnVmZmVyLmpzJyk7XG4gICAgbGluZXMuc2hvdWxkLmNvbnRhaW4oJ2VjaG8uc2gnKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJyNzdGFydCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHRocm93IGFuIGVycm9yIGlmIGNvbW1hbmQgZmFpbHMgb24gc3RhcnR1cCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBzID0gbmV3IFN1YlByb2Nlc3MoJ2JsYXJnaW1hcmcnKTtcbiAgICAgIGF3YWl0IHMuc3RhcnQoKS5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoL0VOT0VOVC8pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgaGF2ZSBhIGRlZmF1bHQgc3RhcnREZXRlY3RvciBvZiB3YWl0aW5nIGZvciBvdXRwdXQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgaGFzRGF0YSA9IGZhbHNlO1xuICAgICAgbGV0IHMgPSBuZXcgU3ViUHJvY2VzcygnbHMnKTtcbiAgICAgIHMub24oJ291dHB1dCcsIChzdGRvdXQpID0+IHtcbiAgICAgICAgaWYgKHN0ZG91dCkge1xuICAgICAgICAgIGhhc0RhdGEgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHMuc3RhcnQoKTtcbiAgICAgIGhhc0RhdGEuc2hvdWxkLmJlLnRydWU7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBpbnRlcnByZXQgYSBudW1lcmljIHN0YXJ0RGV0ZWN0b3IgYXMgYSBzdGFydCB0aW1lb3V0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IGhhc0RhdGEgPSBmYWxzZTtcbiAgICAgIGxldCBzID0gbmV3IFN1YlByb2Nlc3MoZ2V0Rml4dHVyZSgnc2xlZXB5cHJvYy5zaCcpLCBbJ2xzJ10pO1xuICAgICAgcy5vbignb3V0cHV0JywgKHN0ZG91dCkgPT4ge1xuICAgICAgICBpZiAoc3Rkb3V0KSB7XG4gICAgICAgICAgaGFzRGF0YSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgYXdhaXQgcy5zdGFydCgwKTtcbiAgICAgIGhhc0RhdGEuc2hvdWxkLmJlLmZhbHNlO1xuICAgICAgYXdhaXQgQi5kZWxheSgxMjAwKTtcbiAgICAgIGhhc0RhdGEuc2hvdWxkLmJlLnRydWU7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBmYWlsIGV2ZW4gd2l0aCBhIHN0YXJ0IHRpbWVvdXQgb2YgMCB3aGVuIGNvbW1hbmQgaXMgYmFkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHMgPSBuZXcgU3ViUHJvY2VzcygnYmxhcmdpbWFyZycpO1xuICAgICAgYXdhaXQgcy5zdGFydCgwKS5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoL0VOT0VOVC8pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgYmUgYWJsZSB0byBwcm92aWRlIGEgY3VzdG9tIHN0YXJ0RGV0ZWN0b3IgZnVuY3Rpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc2QgPSAoc3Rkb3V0KSA9PiB7IHJldHVybiBzdGRvdXQ7IH07XG4gICAgICBsZXQgaGFzRGF0YSA9IGZhbHNlO1xuICAgICAgbGV0IHMgPSBuZXcgU3ViUHJvY2VzcygnbHMnKTtcbiAgICAgIHMub24oJ291dHB1dCcsIChzdGRvdXQpID0+IHtcbiAgICAgICAgaWYgKHN0ZG91dCkge1xuICAgICAgICAgIGhhc0RhdGEgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHMuc3RhcnQoc2QpO1xuICAgICAgaGFzRGF0YS5zaG91bGQuYmUudHJ1ZTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHBhc3Mgb24gY3VzdG9tIGVycm9ycyBmcm9tIHN0YXJ0RGV0ZWN0b3InLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc2QgPSAoKSA9PiB7IHRocm93IG5ldyBFcnJvcignZm9vJyk7IH07XG4gICAgICBsZXQgcyA9IG5ldyBTdWJQcm9jZXNzKCdscycpO1xuICAgICAgYXdhaXQgcy5zdGFydChzZCkuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKC9mb28vKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHRpbWUgb3V0IHN0YXJ0cyB0aGF0IHRha2UgbG9uZ2VyIHRoYW4gc3BlY2lmaWVkIG1zJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHNkID0gKHN0ZG91dCkgPT4geyByZXR1cm4gc3Rkb3V0LmluZGV4T2YoJ25vdGhlcmUnKSAhPT0gLTE7IH07XG4gICAgICBsZXQgcyA9IG5ldyBTdWJQcm9jZXNzKCdscycpO1xuICAgICAgbGV0IHN0YXJ0ID0gRGF0ZS5ub3coKTtcbiAgICAgIGF3YWl0IHMuc3RhcnQoc2QsIDUwMCkuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKC9kaWQgbm90IHN0YXJ0Lit0aW1lL2kpO1xuICAgICAgKERhdGUubm93KCkgLSBzdGFydCkuc2hvdWxkLmJlLmJlbG93KDYwMCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdsaXN0ZW5pbmcgZm9yIGRhdGEnLCAoKSA9PiB7XG4gICAgbGV0IHN1YnByb2M7XG4gICAgaXQoJ3Nob3VsZCBnZXQgb3V0cHV0IGFzIHBhcmFtcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlKSA9PiB7XG4gICAgICAgIHN1YnByb2MgPSBuZXcgU3ViUHJvY2VzcyhnZXRGaXh0dXJlKCdzbGVlcHlwcm9jLnNoJyksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbJ2xzJywgcGF0aC5yZXNvbHZlKF9fZGlybmFtZSldKTtcbiAgICAgICAgc3VicHJvYy5vbignb3V0cHV0JywgKHN0ZG91dCkgPT4ge1xuICAgICAgICAgIGlmIChzdGRvdXQgJiYgc3Rkb3V0LmluZGV4T2YoJ3N1YnByb2Mtc3BlY3MnKSAhPT0gLTEpIHtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBhd2FpdCBzdWJwcm9jLnN0YXJ0KCk7XG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHN1YnByb2Muc3RvcCgpO1xuXG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSkgPT4ge1xuICAgICAgICBzdWJwcm9jID0gbmV3IFN1YlByb2Nlc3MoZ2V0Rml4dHVyZSgnZWNoby5zaCcpLCBbJ2ZvbycsICdiYXInXSk7XG4gICAgICAgIHN1YnByb2Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgICAgIGlmIChzdGRlcnIgJiYgc3RkZXJyLmluZGV4T2YoJ2JhcicpICE9PSAtMSkge1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IHN1YnByb2Muc3RhcnQoKTtcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgc3VicHJvYy5zdG9wKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGdldCBvdXRwdXQgYnkgbGluZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBzdWJwcm9jID0gbmV3IFN1YlByb2Nlc3MoJ2xzJywgW3BhdGgucmVzb2x2ZShfX2Rpcm5hbWUpXSk7XG4gICAgICBsZXQgbGluZXMgPSBbXTtcbiAgICAgIHN1YnByb2Mub24oJ2xpbmVzLXN0ZG91dCcsIChuZXdMaW5lcykgPT4ge1xuICAgICAgICBsaW5lcyA9IGxpbmVzLmNvbmNhdChuZXdMaW5lcyk7XG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHN1YnByb2Muc3RhcnQoMCk7XG4gICAgICBhd2FpdCBCLmRlbGF5KDUwKTtcbiAgICAgIGxpbmVzLnNob3VsZC5lcWwoWydleGVjLXNwZWNzLmpzJywgJ2ZpeHR1cmVzJywgJ2hlbHBlcnMuanMnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ3N1YnByb2Mtc3BlY3MuanMnXSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCcjc3RvcCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHNlbmQgdGhlIHJpZ2h0IHNpZ25hbCB0byBzdG9wIGEgcHJvYycsIGFzeW5jICgpID0+IHtcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGxldCBzdWJwcm9jID0gbmV3IFN1YlByb2Nlc3MoJ3RhaWwnLCBbJy1mJywgcGF0aC5yZXNvbHZlKF9fZmlsZW5hbWUpXSk7XG4gICAgICAgIGF3YWl0IHN1YnByb2Muc3RhcnQoKTtcbiAgICAgICAgc3VicHJvYy5vbignZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgc2lnbmFsLnNob3VsZC5lcXVhbCgnU0lHSFVQJyk7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IHN1YnByb2Muc3RvcCgnU0lHSFVQJyk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGltZSBvdXQgaWYgc3RvcCBkb2VzbnQgY29tcGxldGUgZmFzdCBlbm91Z2gnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc3VicHJvYyA9IG5ldyBTdWJQcm9jZXNzKGdldEZpeHR1cmUoJ3RyYXBodXAuc2gnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgWyd0YWlsJywgJy1mJywgcGF0aC5yZXNvbHZlKF9fZmlsZW5hbWUpXSk7XG4gICAgICBhd2FpdCBzdWJwcm9jLnN0YXJ0KCk7XG4gICAgICBhd2FpdCBzdWJwcm9jLnN0b3AoJ1NJR0hVUCcsIDEwKVxuICAgICAgICAgICAgICAuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKC9Qcm9jZXNzIGRpZG4ndCBlbmQvKTtcblxuICAgICAgLy8gbmVlZCB0byBraWxsIHRoZSBwcm9jZXNzXG4gICAgICAvLyAxIGZvciB0aGUgdHJhcCwgMSBmb3IgdGhlIHRhaWxcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGV4ZWMoJ2tpbGwnLCBbJy05Jywgc3VicHJvYy5wcm9jLnBpZCArIDFdKTtcbiAgICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGV4ZWMoJ2tpbGwnLCBbJy05Jywgc3VicHJvYy5wcm9jLnBpZF0pO1xuICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBlcnJvciBpZiB0aGVyZSBpcyBubyBwcm9jZXNzIHRvIHN0b3AnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc3VicHJvYyA9IG5ldyBTdWJQcm9jZXNzKCdscycpO1xuICAgICAgYXdhaXQgc3VicHJvYy5zdG9wKCkuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKC9DYW4ndCBzdG9wLyk7XG4gICAgICBhd2FpdCBzdWJwcm9jLnN0YXJ0KCk7XG4gICAgICBhd2FpdCBCLmRlbGF5KDEwKTtcbiAgICAgIGF3YWl0IHN1YnByb2Muc3RvcCgpLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgvQ2FuJ3Qgc3RvcC8pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnI2pvaW4nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBmYWlsIGlmIHRoZSAjc3RhcnQgaGFzIG5vdCB5ZXQgYmVlbiBjYWxsZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwcm9jID0gbmV3IFN1YlByb2Nlc3MoZ2V0Rml4dHVyZSgnc2xlZXB5cHJvYy5zaCcpLCBbJ2xzJ10pO1xuICAgICAgYXdhaXQgcHJvYy5qb2luKCkuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKC9DYW4ndCBqb2luLyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHdhaXQgdW50aWwgdGhlIHByb2Nlc3MgaGFzIGJlZW4gZmluaXNoZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwcm9jID0gbmV3IFN1YlByb2Nlc3MoZ2V0Rml4dHVyZSgnc2xlZXB5cHJvYy5zaCcpLCBbJ2xzJ10pO1xuICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgIGF3YWl0IHByb2Muc3RhcnQoMCk7XG4gICAgICBhd2FpdCBwcm9jLmpvaW4oKTtcbiAgICAgIGNvbnN0IGRpZmYgPSBEYXRlLm5vdygpIC0gbm93O1xuICAgICAgZGlmZi5zaG91bGQuYmUuYWJvdmUoMTAwMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IGlmIHByb2Nlc3MgZW5kcyB3aXRoIGEgaW52YWxpZCBleGl0Y29kZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHByb2MgPSBuZXcgU3ViUHJvY2VzcyhnZXRGaXh0dXJlKCdiYWRfZXhpdC5zaCcpKTtcbiAgICAgIGF3YWl0IHByb2Muc3RhcnQoMCk7XG4gICAgICBhd2FpdCBwcm9jLmpvaW4oKS5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoL1Byb2Nlc3MgZW5kZWQgd2l0aCBleGl0Y29kZS8pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBOT1QgdGhyb3cgaWYgcHJvY2VzcyBlbmRzIHdpdGggYSBjdXN0b20gYWxsb3dlZCBleGl0Y29kZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHByb2MgPSBuZXcgU3ViUHJvY2VzcyhnZXRGaXh0dXJlKCdiYWRfZXhpdC5zaCcpKTtcbiAgICAgIGF3YWl0IHByb2Muc3RhcnQoMCk7XG4gICAgICBhd2FpdCBwcm9jLmpvaW4oWzFdKS5zaG91bGQuZXZlbnR1YWxseS5iZS5iZWNvbWUoMSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=