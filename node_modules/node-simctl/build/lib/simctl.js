'use strict';

var _Object$defineProperty = require('babel-runtime/core-js/object/define-property')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

_Object$defineProperty(exports, '__esModule', {
  value: true
});

var _q = require('q');

var _q2 = _interopRequireDefault(_q);

var _teen_process = require('teen_process');

var _asyncbox = require('asyncbox');

var _appiumLogger = require('appium-logger');

var _es6Mapify = require('es6-mapify');

var log = (0, _appiumLogger.getLogger)('node-simctl');

function simExec(command, timeout) {
  var args = arguments[2] === undefined ? [] : arguments[2];

  args = ['simctl', command].concat(args);
  log.info('Executing: xcrun with args: ' + args.join(' ') + ' and timeout: ' + timeout);

  var ret = undefined;
  try {
    ret = (0, _teen_process.exec)('xcrun', args, { timeout: timeout });
  } catch (e) {
    if (e.stderr) {
      log.errorAndThrow('sim-ctl error: ' + e.stderr.trim());
    } else {
      throw e;
    }
  }

  return ret;
}

function installApp(udid, appPath) {
  return _regeneratorRuntime.async(function installApp$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('install', 0, [udid, appPath]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function removeApp(udid, bundleId) {
  return _regeneratorRuntime.async(function removeApp$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('uninstall', 0, [udid, bundleId]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function launch(udid, bundleId) {
  return _regeneratorRuntime.async(function launch$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('launch', 0, [udid, bundleId]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function shutdown(udid) {
  return _regeneratorRuntime.async(function shutdown$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('shutdown', 0, [udid]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function createDevice(name, deviceTypeId, runtimeId) {
  var out;
  return _regeneratorRuntime.async(function createDevice$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        out = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(simExec('create', 0, [name, deviceTypeId, runtimeId]));

      case 4:
        out = context$1$0.sent;
        context$1$0.next = 10;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        log.errorAndThrow('Could not create simulator. Reason: ' + context$1$0.t0.stderr.trim());

      case 10:
        return context$1$0.abrupt('return', out.stdout.trim());

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
}

function deleteDevice(udid) {
  return _regeneratorRuntime.async(function deleteDevice$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('delete', 0, [udid]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function eraseDevice(udid) {
  var cmdTimeout, cmdRetry, loopFn;
  return _regeneratorRuntime.async(function eraseDevice$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        cmdTimeout = 2000, cmdRetry = 5;

        loopFn = function loopFn() {
          var ms;
          return _regeneratorRuntime.async(function loopFn$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                ms = Date.now();
                context$2$0.prev = 1;
                context$2$0.next = 4;
                return _regeneratorRuntime.awrap(simExec('erase', cmdTimeout, [udid]));

              case 4:
                context$2$0.next = 11;
                break;

              case 6:
                context$2$0.prev = 6;
                context$2$0.t0 = context$2$0['catch'](1);
                context$2$0.next = 10;
                return _regeneratorRuntime.awrap((0, _asyncbox.sleep)(Math.max(cmdTimeout - (Date.now() - ms), 1)));

              case 10:
                throw context$2$0.t0;

              case 11:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this, [[1, 6]]);
        };

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _asyncbox.retry)(cmdRetry, loopFn));

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getDevices() {
  var forSdk = arguments[0] === undefined ? null : arguments[0];

  var _ref, stdout, deviceSecRe, matches, devices, match, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, sdk, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, line, lineRe, lineMatch, device;

  return _regeneratorRuntime.async(function getDevices$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('list', 0, ['devices']));

      case 2:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        deviceSecRe = /-- iOS (.+) --(\n    .+)*/mg;
        matches = [];
        devices = {};
        match = deviceSecRe.exec(stdout);

        while (match !== null) {
          matches.push(match);
          match = deviceSecRe.exec(stdout);
        }

        if (!(matches.length < 1)) {
          context$1$0.next = 11;
          break;
        }

        throw new Error('Could not find device section');

      case 11:
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 14;
        _iterator = _getIterator(matches);

      case 16:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 56;
          break;
        }

        match = _step.value;
        sdk = match[1];

        devices[sdk] = [];
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 23;
        _iterator2 = _getIterator(match[0].split('\n').slice(1));

      case 25:
        if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
          context$1$0.next = 39;
          break;
        }

        line = _step2.value;
        lineRe = /^    ([^\(]+) \(([^\)]+)\) \(([^\)]+)\)/;
        lineMatch = lineRe.exec(line);

        if (!(lineMatch === null)) {
          context$1$0.next = 31;
          break;
        }

        throw new Error('Couldn\'t match line');

      case 31:
        device = {};

        device.name = lineMatch[1];
        device.udid = lineMatch[2];
        device.state = lineMatch[3];
        devices[sdk].push(device);

      case 36:
        _iteratorNormalCompletion2 = true;
        context$1$0.next = 25;
        break;

      case 39:
        context$1$0.next = 45;
        break;

      case 41:
        context$1$0.prev = 41;
        context$1$0.t0 = context$1$0['catch'](23);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t0;

      case 45:
        context$1$0.prev = 45;
        context$1$0.prev = 46;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 48:
        context$1$0.prev = 48;

        if (!_didIteratorError2) {
          context$1$0.next = 51;
          break;
        }

        throw _iteratorError2;

      case 51:
        return context$1$0.finish(48);

      case 52:
        return context$1$0.finish(45);

      case 53:
        _iteratorNormalCompletion = true;
        context$1$0.next = 16;
        break;

      case 56:
        context$1$0.next = 62;
        break;

      case 58:
        context$1$0.prev = 58;
        context$1$0.t1 = context$1$0['catch'](14);
        _didIteratorError = true;
        _iteratorError = context$1$0.t1;

      case 62:
        context$1$0.prev = 62;
        context$1$0.prev = 63;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 65:
        context$1$0.prev = 65;

        if (!_didIteratorError) {
          context$1$0.next = 68;
          break;
        }

        throw _iteratorError;

      case 68:
        return context$1$0.finish(65);

      case 69:
        return context$1$0.finish(62);

      case 70:
        if (!forSdk) {
          context$1$0.next = 74;
          break;
        }

        if (devices[forSdk]) {
          context$1$0.next = 73;
          break;
        }

        throw new Error('Sdk ' + forSdk + ' was not in list of simctl sdks');

      case 73:
        return context$1$0.abrupt('return', devices[forSdk]);

      case 74:
        return context$1$0.abrupt('return', devices);

      case 75:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[14, 58, 62, 70], [23, 41, 45, 53], [46,, 48, 52], [63,, 65, 69]]);
}

exports.installApp = installApp;
exports.removeApp = removeApp;
exports.launch = launch;
exports.shutdown = shutdown;
exports.createDevice = createDevice;
exports.deleteDevice = deleteDevice;
exports.eraseDevice = eraseDevice;
exports.getDevices = getDevices;

// retry erase with a sleep in between because it's flakey
//# sourceMappingURL=data:application/json;base64,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QyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDOzs7Ozs7OztBQUE1QyxZQUFXO0FBQ2QsY0FBYSxHQUFHLHlDQUF5QztBQUN6RCxpQkFBZ0IsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzs7Y0FDcEMsU0FBUyxLQUFLLElBQUksQ0FBQTs7Ozs7Y0FDZCxJQUFJLEtBQUssQ0FBQyxzQkFBcUIsQ0FBQzs7O0FBRXBDLGNBQWEsR0FBRyxFQUFFOztBQUN0QixjQUFNLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMzQixjQUFNLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMzQixjQUFNLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM1QixlQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7YUFHMUIsTUFBTTs7Ozs7WUFDSCxPQUFPLENBQUMsTUFBTSxDQUFDOzs7OztjQUNaLElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxNQUFNLEdBQUcsaUNBQWlDLENBQUM7Ozs0Q0FFL0QsT0FBTyxDQUFDLE1BQU0sQ0FBQzs7OzRDQUVqQixPQUFPOzs7Ozs7O0NBQ2Y7O1FBRVEsVUFBVSxHQUFWLFVBQVU7UUFBRSxTQUFTLEdBQVQsU0FBUztRQUFFLE1BQU0sR0FBTixNQUFNO1FBQUUsUUFBUSxHQUFSLFFBQVE7UUFBRSxZQUFZLEdBQVosWUFBWTtRQUFFLFlBQVksR0FBWixZQUFZO1FBQUUsV0FBVyxHQUFYLFdBQVc7UUFBRSxVQUFVLEdBQVYsVUFBVSIsImZpbGUiOiJsaWIvc2ltY3RsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFEgZnJvbSAncSc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IHNsZWVwLCByZXRyeSwgbm9kZWlmeUFsbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGdldExvZ2dlciB9IGZyb20gJ2FwcGl1bS1sb2dnZXInO1xuaW1wb3J0IHsgbWFwaWZ5IH0gZnJvbSAnZXM2LW1hcGlmeSc7XG5cbmNvbnN0IGxvZyA9IGdldExvZ2dlcignbm9kZS1zaW1jdGwnKTtcblxuZnVuY3Rpb24gc2ltRXhlYyAoY29tbWFuZDpzdHJpbmcsIHRpbWVvdXQ6bnVtYmVyLCBhcmdzOkFycmF5ID0gW10pIHtcblxuICBhcmdzID0gW1wic2ltY3RsXCIsIGNvbW1hbmRdLmNvbmNhdChhcmdzKTtcbiAgbG9nLmluZm8oYEV4ZWN1dGluZzogeGNydW4gd2l0aCBhcmdzOiAke2FyZ3Muam9pbignICcpfSBhbmQgdGltZW91dDogJHt0aW1lb3V0fWApO1xuXG4gIGxldCByZXQ7XG4gIHRyeSB7XG4gICAgcmV0ID0gZXhlYyhcInhjcnVuXCIsIGFyZ3MsIHt0aW1lb3V0fSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZS5zdGRlcnIpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBzaW0tY3RsIGVycm9yOiAke2Uuc3RkZXJyLnRyaW0oKX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmV0O1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsQXBwICh1ZGlkOnN0cmluZywgYXBwUGF0aDpzdHJpbmcpOnZvaWQge1xuICBhd2FpdCBzaW1FeGVjKFwiaW5zdGFsbFwiLCAwLCBbdWRpZCwgYXBwUGF0aF0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZW1vdmVBcHAgKHVkaWQ6c3RyaW5nLCBidW5kbGVJZDpzdHJpbmcpOnZvaWQge1xuICBhd2FpdCBzaW1FeGVjKFwidW5pbnN0YWxsXCIsIDAsIFt1ZGlkLCBidW5kbGVJZF0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBsYXVuY2ggKHVkaWQ6c3RyaW5nLCBidW5kbGVJZDpzdHJpbmcpOnZvaWQge1xuICBhd2FpdCBzaW1FeGVjKFwibGF1bmNoXCIsIDAsIFt1ZGlkLCBidW5kbGVJZF0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzaHV0ZG93biAodWRpZDpzdHJpbmcpOnZvaWQge1xuICBhd2FpdCBzaW1FeGVjKFwic2h1dGRvd25cIiwgMCwgW3VkaWRdKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlRGV2aWNlIChuYW1lOnN0cmluZywgZGV2aWNlVHlwZUlkOnN0cmluZyxcbiAgICBydW50aW1lSWQ6c3RyaW5nKTp2b2lkIHtcblxuICBsZXQgb3V0O1xuICB0cnkge1xuICAgIG91dCA9IGF3YWl0IHNpbUV4ZWMoXCJjcmVhdGVcIiwgMCwgW25hbWUsIGRldmljZVR5cGVJZCwgcnVudGltZUlkXSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ291bGQgbm90IGNyZWF0ZSBzaW11bGF0b3IuIFJlYXNvbjogJHtlLnN0ZGVyci50cmltKCl9YCk7XG4gIH1cbiAgcmV0dXJuIG91dC5zdGRvdXQudHJpbSgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZWxldGVEZXZpY2UgKHVkaWQ6c3RyaW5nKTp2b2lkIHtcbiAgYXdhaXQgc2ltRXhlYyhcImRlbGV0ZVwiLCAwLCBbdWRpZF0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBlcmFzZURldmljZSAodWRpZDpzdHJpbmcpOnZvaWQge1xuICBsZXQgY21kVGltZW91dDpudW1iZXIgPSAyMDAwLCBjbWRSZXRyeTpudW1iZXIgPSA1O1xuICBsZXQgbG9vcEZuOkZ1bmN0aW9uID0gYXN5bmMgKCkgPT4ge1xuICAgIGxldCBtcyA9IERhdGUubm93KCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHNpbUV4ZWMoXCJlcmFzZVwiLCBjbWRUaW1lb3V0LCBbdWRpZF0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGF3YWl0IHNsZWVwKE1hdGgubWF4KGNtZFRpbWVvdXQgLSAoRGF0ZS5ub3coKSAtIG1zKSwgMSkpO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH07XG4gIC8vIHJldHJ5IGVyYXNlIHdpdGggYSBzbGVlcCBpbiBiZXR3ZWVuIGJlY2F1c2UgaXQncyBmbGFrZXlcbiAgYXdhaXQgcmV0cnkoY21kUmV0cnksIGxvb3BGbik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldERldmljZXMgKGZvclNkazpzdHJpbmcgPSBudWxsKTpPYmplY3Qge1xuICBsZXQgeyBzdGRvdXQgfSA9IGF3YWl0IHNpbUV4ZWMoXCJsaXN0XCIsIDAsIFtcImRldmljZXNcIl0pO1xuICBsZXQgZGV2aWNlU2VjUmU6UmVnRXhwID0gLy0tIGlPUyAoLispIC0tKFxcbiAgICAuKykqL21nO1xuICBsZXQgbWF0Y2hlczpBcnJheSA9IFtdO1xuICBsZXQgZGV2aWNlczpPYmplY3QgPSB7fTtcbiAgbGV0IG1hdGNoOk9iamVjdCA9IGRldmljZVNlY1JlLmV4ZWMoc3Rkb3V0KTtcbiAgd2hpbGUgKG1hdGNoICE9PSBudWxsKSB7XG4gICAgbWF0Y2hlcy5wdXNoKG1hdGNoKTtcbiAgICBtYXRjaCA9IGRldmljZVNlY1JlLmV4ZWMoc3Rkb3V0KTtcbiAgfVxuICBpZiAobWF0Y2hlcy5sZW5ndGggPCAxKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiQ291bGQgbm90IGZpbmQgZGV2aWNlIHNlY3Rpb25cIik7XG4gIH1cbiAgZm9yIChtYXRjaCBvZiBtYXRjaGVzKSB7XG4gICAgbGV0IHNkazpzdHJpbmcgPSBtYXRjaFsxXTtcbiAgICBkZXZpY2VzW3Nka10gPSBbXTtcbiAgICBmb3IgKGxldCBsaW5lOnN0cmluZyBvZiBtYXRjaFswXS5zcGxpdChcIlxcblwiKS5zbGljZSgxKSkge1xuICAgICAgbGV0IGxpbmVSZTpSZWdFeHAgPSAvXiAgICAoW15cXChdKykgXFwoKFteXFwpXSspXFwpIFxcKChbXlxcKV0rKVxcKS87XG4gICAgICBsZXQgbGluZU1hdGNoOk9iamVjdCA9IGxpbmVSZS5leGVjKGxpbmUpO1xuICAgICAgaWYgKGxpbmVNYXRjaCA9PT0gbnVsbCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZG4ndCBtYXRjaCBsaW5lXCIpO1xuICAgICAgfVxuICAgICAgbGV0IGRldmljZTpPYmplY3QgPSB7fTtcbiAgICAgIGRldmljZS5uYW1lID0gbGluZU1hdGNoWzFdO1xuICAgICAgZGV2aWNlLnVkaWQgPSBsaW5lTWF0Y2hbMl07XG4gICAgICBkZXZpY2Uuc3RhdGUgPSBsaW5lTWF0Y2hbM107XG4gICAgICBkZXZpY2VzW3Nka10ucHVzaChkZXZpY2UpO1xuICAgIH1cbiAgfVxuICBpZiAoZm9yU2RrKSB7XG4gICAgaWYgKCFkZXZpY2VzW2ZvclNka10pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlNkayBcIiArIGZvclNkayArIFwiIHdhcyBub3QgaW4gbGlzdCBvZiBzaW1jdGwgc2Rrc1wiKTtcbiAgICB9XG4gICAgcmV0dXJuIGRldmljZXNbZm9yU2RrXTtcbiAgfVxuICByZXR1cm4gZGV2aWNlcztcbn1cblxuZXhwb3J0IHsgaW5zdGFsbEFwcCwgcmVtb3ZlQXBwLCBsYXVuY2gsIHNodXRkb3duLCBjcmVhdGVEZXZpY2UsIGRlbGV0ZURldmljZSwgZXJhc2VEZXZpY2UsIGdldERldmljZXMgfTtcbiJdfQ==